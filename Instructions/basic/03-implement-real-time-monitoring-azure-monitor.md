---
lab:
  topic: Basic
  title: Azure Monitor を使用してリアルタイム監視を実装する
  description: Azure Monitor と Application Insights を使用して、アプリケーションの包括的な監視と観測性を実装する方法について説明します。
---

# Azure Monitor を使用してリアルタイム監視を実装する

このラボでは、Azure Monitor と Application Insights を使用して、Web アプリケーションのリアルタイム監視を実装します。 これにより、アプリケーションのパフォーマンスに関する分析情報を得て、異常を検出し、サービスの信頼性を確保することができます。

学習内容:

- サンプル Web アプリケーションを作成します。
- Azure Monitor と Application Insights を有効にして構成します。
- カスタム ダッシュボードを作成して、アプリケーション メトリックを視覚化します。
- パフォーマンスの異常を関係者に通知するアラートを設定します。
- パフォーマンス データを分析して、潜在的な改善を実現します。

このラボの所要時間は約 **20** 分です。

## 開始する前に

ラボを完了するには、以下が必要です。

- アクティブな Azure サブスクリプション。 お持ちでない場合は、[Azure 無料アカウント](https://azure.microsoft.com/free)で無料アカウントを作成できます。
- 監視と可観測性の概念に関する基本的な知識。
- Azure のサービスについての基本的な理解。

## サンプル Web アプリケーションを作成する

この演習では、Azure App Service でサンプル Web アプリケーションを作成し、監視のために Application Insights を有効にします。

### Azure Web アプリを作成する

1. Azure Portalを開きます。
1. 検索バーに「App Service」と入力し、それを選択します。
1. **[+ 作成]** を選択し、**[Web アプリ]** を選択します。
1. [基本] タブで、次の操作を行います。
   - サブスクリプション:Azure サブスクリプションを選択します。
   - リソース グループ:[新規作成] を選択し、**`monitoringlab-rg`** と入力して、[OK] を選択します。
   - 名前: 一意な名前を入力します (例: **`monitoringlab-webapp`**)。
   - 発行: [コード] を選択します。
   - ランタイム スタック: [.NET 8 (LTS)] を選択します。
   - リージョン: 近くのリージョンを選択します。
1. **[Review + create](確認と作成)** を選択し、次に **[作成]** を選択します。
1. デプロイが完了するまで待ち、**[リソースに移動]** を選択します。
1. [概要] タブで、URL を選択して Web アプリが実行されていることを確認します。

### Application Insights を確認する

1. Web アプリ リソースの左側のパネルで [監視] セクションを展開し、**[Application Insights]** を選択します。
1. Application Insights は、この Web アプリに対して既に有効になっています。 リンクを選択して、Application Insights のリソースを開きます。
1. Application Insights のリソースで **[アプリケーション ダッシュボード]** を選択して、提供される既定のダッシュボードのパフォーマンス データを表示します。

   > **注:**  ダッシュボードですべてのパフォーマンス データが完全に読み込まれて表示されるまで、しばらく時間がかかる場合があります。 後の演習で最適なエクスペリエンスを使用できるよう、ダッシュボードが完全にレンダリングされるまで待ってから先に進んでください。

## Azure Monitor とダッシュボードを構成する

### Azure Monitor にアクセスする

1. Azure portal で、「モニター」を検索して **[モニター]** を選択します。
1. 左側のパネルで **[メトリック]** を選択します。
1. [スコープ] セクションで、Web アプリをデプロイしたサブスクリプションとリソース グループの下にある Web アプリを選択します。
1. **[適用]** を選択し、Web アプリで使用できるメトリックを確認します。

### ダッシュボードに主要なメトリックを追加する

1. [スコープ] セクションで、Web アプリ (monitoringlab-webapp) を選択します。
1. [メトリック] で、**[応答時間]** を選択します。
1. [集計] を **[平均]** に設定し、**[+ メトリックの追加]** を選択します。
1. 追加のメトリックがあれば、この手順を繰り返します。
   - CPU 時間 (カウント)
   - リクエスト (平均)
1. メトリック グラフ領域で、グラフの右上隅にある **[ダッシュボードにピン留め]** ボタン (ピン アイコン) を選択します。
1. 表示される **[ダッシュボードにピン留め]** ダイアログで次のようにします。
   - **[新規]** を選んで新しいダッシュボードを作成します
   - ダッシュボード名に「**`MonitoringLab Dashboard`**」と入力します
   - ダッシュボードの種類として **[共有]** を選択します
   - 適切なサブスクリプションを選択します
   - **[作成してピン留めする]** を選択します
1. ダッシュボードが作成され、メトリックがピン留めされたら、上部のメニューで **[保存]** を選択してダッシュボードを保存します。
1. Azure portal の左側のパネルにある **[ダッシュボード]** アイコンを選択してダッシュボードに移動するか、上部の検索バーで「ダッシュボード」を検索します。
1. ダッシュボードの一覧から新しく作成した **MonitoringLab Dashboard** を選びます。
1. メトリックがダッシュボードに表示され、リアルタイムで更新されていることを確認します。

## アラートを作成する

### アラート条件とアクションを定義する

1. Azure Monitor で **[アラート]** を選択します。
1. **[+ 作成]** を選択し、**[アラート ルール]** を選択します。
1. [スコープ] で Web アプリ (monitoringlab-webapp) を選択し、**[適用]** を選択します。
1. [条件] の "シグナル名" フィールドを選択し、**[応答時間]** を選択します。
1. アラート ルールを次のように構成します。
   - しきい値の種類: 動的
   - 集計の種類: 平均
   - 値: 次の値より大きいまたは小さい
   - しきい値の感度: 高
   - 評価の頻度: 1 分ごとに確認し、ルックバックは 5 分。
1. [アクション] で、**[クイック アクションを使用する]** を選択します。
1. 次を入力します。
   - アクション グループ名: WebAppMonitoringAlerts
   - 表示名: WebAlert
   - 電子メール: 自分のメール アドレスを入力します。
1. **[保存]** を選択します。
1. **[Next: Details](次へ: 詳細)** を選択します。
1. 名前「`WebAppResponseTimeAlert`」を入力し、重大度レベル **[詳細]** を選択します。
1. **[確認および作成]** 、 **[作成]** の順に選択します。

   > **注:** これでアラート ルールが作成され、応答時間がしきい値を超えると電子メールによる通知がトリガーされます。 Web アプリに大量の要求を送信することで、アラートを強制的にトリガーできます。 たとえば、Azure Load Testing や、Apache JMeter などのツールを使用できます。

1. [Azure Monitor] - [アラート] に戻ります。
1. **[アラート ルール]** を選択すると、作成したアラート ルールが表示されるはずです。

## パフォーマンス データを分析する

### 収集されたメトリックを確認する

1. Azure portal 内で、 [Application Insights] に移動します。
1. **[アプリケーション ダッシュボード]** を選択します。
1. **[Performance]** タイルを選択して、サーバーの応答時間と負荷を分析します。 要求の数と失敗した要求の数を表示することもできます。
1. **[Workbooks で分析]** を選択し、**[パフォーマンス カウンター分析]** を選択します。
1. **[ブック]** を選択します。
1. [パフォーマンス] で Workbook の **[パフォーマンス分析]** を選択します。
1. Web アプリのパフォーマンス データを確認できます。

> **注:** Workbook をカスタマイズして、追加のメトリックとフィルターを含めることができます。

## リソースをクリーンアップする

これで演習が完了したので、不要なリソース使用を避けるために、作成したクラウド リソースを削除してください。

1. お使いのブラウザーで Azure portal ([https://portal.azure.com](https://portal.azure.com)) に移動し、メッセージに応じて Azure 資格情報を使用してサインインします。
1. 作成したリソース グループに移動し、この演習で使用したリソースの内容を表示します。
1. ツール バーの **[リソース グループの削除]** を選びます。
1. リソース グループ名を入力し、削除することを確認します。

> **注:** リソース グループを削除すると、その中のすべてのリソースが削除されます。 この演習で既存のリソース グループを選択した場合は、この演習の範囲外にある既存のリソースも削除されます。

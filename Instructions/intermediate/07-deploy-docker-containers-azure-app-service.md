---
lab:
  topic: Intermediate
  title: Docker コンテナーを Azure App Service Web アプリにデプロイする
  description: Azure DevOps の CI/CD パイプラインを使って、カスタム Docker イメージをビルドして、Azure Container Registry にプッシュし、コンテナーとして Azure App Service にデプロイする方法を学びます。
---

# Docker コンテナーを Azure App Service Web アプリにデプロイする

このラボでは、Azure DevOps CI/CD パイプラインを使用してカスタム Docker イメージを構築し、それを Azure Container Registry にプッシュして、コンテナーとして Azure App Service にデプロイする方法を学習します。 コンテナー化、Azure Container Registry、自動デプロイを使って作業します。

学習内容:

- Microsoft がホストする Linux エージェントを使ってカスタム Docker イメージをビルドします。
- Azure Container Registry にイメージをプッシュする
- Azure DevOps を使用して、Docker イメージをコンテナーとして Azure App Service にデプロイします。
- コンテナー化されたアプリケーション用に CI/CD パイプラインを構成します。
- Azure でコンテナー化された Web アプリケーションをテストします。

このラボの所要時間は約 **20** 分です。

## 開始する前に

このラボを終えるには、次のものが必要です。

- **Microsoft Edge** または [Azure DevOps 対応ブラウザー](https://learn.microsoft.com/azure/devops/server/compatibility)。
- Azure DevOps 組織。 まだない場合は、[組織またはプロジェクト コレクションの作成](https://learn.microsoft.com/azure/devops/organizations/accounts/create-organization)に関する記事の手順に従って作成します。
- **Azure サブスクリプション**:まだ Azure サブスクリプションをお持ちでない場合は、[Azure 無料アカウント](https://azure.microsoft.com/free) ページで無料アカウントにサインアップしてください。
- Azure サブスクリプションで**共同作成者**または**所有者**のロールを持つ Microsoft アカウントまたは Microsoft Entra アカウントを持っていることを確認します。 詳細については、[「Azure portal を使用して Azure ロールの割り当てを一覧表示する」](https://learn.microsoft.com/azure/role-based-access-control/role-assignments-list-portal)および[「Azure Active Directory で管理者ロールを表示して割当てる」](https://learn.microsoft.com/azure/active-directory/roles/manage-roles-portal)を参照してください。

### Azure DevOps 組織を設定する (必要な場合)

Azure DevOps 組織がまだない場合は、次の手順のようにします。

1. プライベート ブラウザー セッションを使って、`https://account.microsoft.com` で新しい**個人用 Microsoft アカウント (MSA)** を取得します (既にお持ちの場合はスキップしてください)。
1. 同じブラウザー セッションを使って、`https://azure.microsoft.com/free` で無料の Azure サブスクリプションにサインアップします (既にお持ちの場合はスキップしてください)。
1. ブラウザーを開き、`https://portal.azure.com` の Azure portal に移動し、Azure portal 画面の上部で **Azure DevOps** を検索します。 表示されたページで、**[Azure DevOps 組織]** を選びます。
1. 次に、**[自分の Azure DevOps 組織]** というラベルの付いたリンクを選ぶか、`https://aex.dev.azure.com` に直接移動します。
1. **[We need a few more details](詳細情報をいくつか入力する必要があります)** ページで、 **[続行]** を選びます。
1. 左側のドロップダウン ボックスで、**Microsoft アカウント**の代わりに **[既定のディレクトリ]** を選びます。
1. [詳細情報をいくつか入力する必要があります] というメッセージが表示されたら、名前、メール アドレス、場所を入力して、**[続行]** を選びます。__
1. **[既定のディレクトリ]** を選んで `https://aex.dev.azure.com` に戻り、青い **[新しい組織の作成]** ボタンを選びます。
1. **[続行]** を選んで "サービス使用条件" を承諾します。__
1. プロンプト ( _[Almost done](ほぼ完了)_ ) が表示されたら、Azure DevOps 組織の名前を既定のままにし (グローバルに一意の名前である必要があります)、一覧から最寄りのホスティング場所を選びます。
1. 新しく作成した組織が **Azure DevOps** で開いたら、左下隅にある **[組織設定]** を選びます。
1. **[組織設定]** 画面で、**[課金情報]** を選びます (この画面を開くには数秒かかります)。
1. **[課金の設定]** を選び、画面の右側で **[Azure サブスクリプション]**、**[保存]** の順に選んでサブスクリプションを組織にリンクします。
1. 画面の上部にリンクされた Azure サブスクリプション ID が表示されたら、**MS Hosted CI/CD** の**有料並列ジョブ**の数を 0 から **1** に変更します。 次に、下部にある **[保存]** を選びます。

   > **注**: **CI/CD 機能を使用する前に数分間待つ**と、新しい設定がバックエンドに反映されます。 それができなかった場合、 _"ホストされた並列処理は購入も許可もされていません"_ というメッセージが依然として表示されます。

1. **[組織の設定]** の **[パイプライン]** セクションに移動して、**[設定]** を選びます。
1. **[クラシック ビルド パイプラインの作成を無効にする]** と **[クラシック リリース パイプラインの作成を無効にする]** を **[オフ]** に切り替えます。
1. **[組織の設定]** で、**[セキュリティ]** セクションに移動して **[ポリシー]** を選びます。
1. **[パブリック プロジェクトを許可します]** を **[オン]** に切り替えます。

### Azure DevOps プロジェクトを作成して構成する (必要な場合)

1. ブラウザーを開き、Azure DevOps 組織に移動します。
1. **[新しいプロジェクト]** オプションを選び、次の設定を使用します。
   - 名前: **eShopOnWeb**
   - 可視性: **プライベート**
   - 詳細設定: バージョン コントロール: **Git**
   - 詳細設定: 作業項目プロセス: **スクラム**
1. **［作成］** を選択します

### eShopOnWeb Git リポジトリをインポートする (必要な場合)

1. 前に作成した **eShopOnWeb** プロジェクトを開きます。
1. **[Repos] > [ファイル]** を選び、**[リポジトリをインポートする]**、**[インポート]** の順に選びます。
1. **[Git リポジトリをインポートする]** ウィンドウで、URL `https://github.com/MicrosoftLearning/eShopOnWeb.git` を貼り付けて、**[インポート]** を選びます。

1. リポジトリは次のように編成されています。

   - **.ado** フォルダーには、Azure DevOps の YAML パイプラインが含まれています。
   - **.devcontainer** フォルダーには、コンテナーを使って開発するためのセットアップが含まれています (VS Code でローカルに、または GitHub Codespaces で)。
   - **infra** フォルダーには、一部のラボ シナリオで使用される Bicep および ARM のコードとしてのインフラストラクチャ テンプレートが含まれています。
   - **.github** フォルダーには、YAML GitHub ワークフローの定義が含まれています。
   - **src** フォルダーには、ラボ シナリオで使用される .NET 8 Web サイトが含まれています。

1. Web ブラウザーのウィンドウは開いたままにしておきます。
1. **[リポジトリ]、[ブランチ]** に移動します。
1. **メイン** ブランチをポイントし、列の右側にある省略記号を選びます。
1. **[既定のブランチとして設定]** を選びます。

## CI パイプラインをインポートして実行する

このセクションでは、Azure サブスクリプションとのサービス接続を構成した後、CI パイプラインをインポートして実行します。

### CI パイプラインをインポートして実行する

1. **[パイプライン] - [パイプライン]** に移動します
1. **[新しいパイプライン]** ボタン (または、これまでに他のパイプラインを作成したことがない場合は **[パイプラインの作成]**) を選びます
1. **[Azure Repos Git (YAML)]** を選びます
1. **eShopOnWeb** リポジトリを選びます
1. **[既存の Azure Pipelines YAML ファイル]** を選択します。
1. **メイン** ブランチと **/.ado/eshoponweb-ci-docker.yml** ファイルを選んでから、**[続行]** を選びます
1. YAML パイプライン定義で、次をカスタマイズします。

   - **YOUR-SUBSCRIPTION-ID** を、お使いの Azure サブスクリプション ID に置き換えます。
   - **resourceGroup** は、使用するリソース グループ名に置き換えます (例: **AZ400-RG1**)。

1. パイプライン定義を確認します。 CI の定義は以下のタスクで構成されます。

   - **リソース**: 以下のタスクで使われるリポジトリ ファイルをダウンロードします。
   - **AzureResourceManagerTemplateDeployment**: bicep テンプレートを使用して Azure Container Registry をデプロイします。
   - **PowerShell**: 前のタスクの出力から **ACR ログイン サーバー**の値を取得し、新しいパラメーター **acrLoginServer** を作成します
   - [**Docker**](https://learn.microsoft.com/azure/devops/pipelines/tasks/reference/docker-v0?view=azure-pipelines) **- Build**: Docker イメージをビルドし、2 つのタグを作成します (最新と現在の BuildID)
   - **Docker - Push**: Azure Container Registry にイメージをプッシュします

1. **[保存して実行]** を選びます。

1. パイプラインの実行を開きます。 "この実行を続行してビルドに進む前に、リソースにアクセスするためのアクセス許可がこのパイプラインに必要です" という警告メッセージが表示される場合は、**[表示]**、**[許可]**、もう一度 **[許可]** の順に選びます。 これにより、パイプラインが Azure サブスクリプションにアクセスできるようになります。

   > **注**: デプロイが完了するまでに数分かかる場合があります。

1. パイプラインには、プロジェクト名に基づく名前が付けられます。 パイプラインを識別しやすくするために、**名前を変更**しましょう。 **[パイプライン] > [パイプライン]** に移動し、先ほど作成したパイプラインを選びます。 省略記号を選んで、**[名前の変更/移動]** オプションを選びます。 **eshoponweb-ci-docker** という名前を付けて、**[保存]** を選びます。

1. [**Azure portal**](https://portal.azure.com) に移動し、先ほど作成したリソース グループ (**AZ400-RG1** という名前であるはずです) で Azure Container Registry を検索します。 左側の **[サービス]** の下にある **[リポジトリ]** を選んで、リポジトリ **eshoponweb/web** が作成されたことを確認します。 リポジトリのリンクを選ぶと、2 つのタグ (そのうちの 1 つは **[最新]**) が表示されます。これらはプッシュされたイメージです。 これが表示されない場合は、パイプラインの状態を調べます。

## CD パイプラインをインポートして実行する

このセクションでは、Azure サブスクリプションとのサービス接続を構成した後、CD パイプラインをインポートして実行します。

### CD パイプラインをインポートして実行する

このタスクでは、CD パイプラインをインポートして実行します。

1. **[パイプライン]、[パイプライン]** の順に移動します
1. **[新しいパイプライン]** ボタンを選びます
1. **[Azure Repos Git (YAML)]** を選びます
1. **eShopOnWeb** リポジトリを選びます
1. **[既存の Azure Pipelines の YAML ファイル]** を選択します
1. **メイン** ブランチと **/.ado/eshoponweb-cd-webapp-docker.yml** ファイルを選んで、**[続行]** を選びます
1. YAML パイプライン定義で、次をカスタマイズします。

   - **YOUR-SUBSCRIPTION-ID** を、お使いの Azure サブスクリプション ID に置き換えます。
   - **resourceGroup** を、サービス接続の作成時に使用するリソース グループ名 (**AZ400-RG1** など) に置き換えます。
   - **location** を、リソースがデプロイされる Azure リージョンに置き換えます。

1. パイプライン定義を確認します。 CD の定義は以下のタスクで構成されます。

   - **リソース**: 以下のタスクで使われるリポジトリ ファイルをダウンロードします。
   - **AzureResourceManagerTemplateDeployment**: bicep テンプレートを使用して Azure App Service をデプロイします。
   - **AzureResourceManagerTemplateDeployment**: Bicep を使用してロールの割り当てを追加します

1. **[保存して実行]** を選びます。

1. パイプラインの実行を開きます。 "この実行を続行してデプロイに進む前に、リソースにアクセスするためのアクセス許可がこのパイプラインに必要です" という警告メッセージが表示される場合は、**[表示]**、**[許可]**、もう一度 **[許可]** の順に選びます。 これにより、パイプラインが Azure サブスクリプションにアクセスできるようになります。

   > **重要**: 構成時にパイプラインを承認しないと、実行中にアクセス許可エラーが発生します。 一般的なエラー メッセージには、"このパイプラインにはリソースにアクセスするためのアクセス許可が必要です" や "アクセス許可が不十分なためパイプラインの実行に失敗しました" などがあります。 これを解決するには、パイプライン実行に移動し、アクセス許可要求の横にある **[表示]** を選んでから **[アクセス許可]** を選び、Azure サブスクリプションとリソースに必要なアクセス権を付与します。

   > **注**: デプロイが完了するまでに数分かかる場合があります。

   > [!IMPORTANT]
   > "TF402455: このブランチに対するプッシュは許可されていません。このブランチを更新するには pull request を使用する必要があります" というエラー メッセージが表示された場合は、前のラボで有効にした [最小数のレビュー担当者が必要です] というブランチ保護ルールをオフにする必要があります。

1. パイプラインには、プロジェクト名に基づく名前が付けられます。 パイプラインを識別しやすくするために、**名前を変更**しましょう。 **[パイプライン]、[パイプライン]** の順に移動し、先ほど作成したパイプラインにマウス ポインターを合わせます。 省略記号を選んで、**[名前の変更/移動]** オプションを選びます。 **eshoponweb-cd-webapp-docker** という名前を付けて、**[保存]** を選びます。

   > **注 1**: **/infra/webapp-docker.bicep** テンプレートを使用すると、アプリ サービス プラン、システム割り当てマネージド ID が有効な Web アプリが作成され、前にプッシュされた Docker イメージ **${acr.properties.loginServer}/eshoponweb/web:latest** が作成されます。

   > **注 2**:**/infra/webapp-to-acr-roleassignment.bicep** テンプレートを使用すると、Docker イメージを取得できるように、AcrPull ロールを使用して Web アプリの新しいロールの割り当てが作成されます。 これは最初のテンプレートで実行される可能性がありますが、ロールの割り当てが反映されるまでには時間がかかることがあるため、両方のタスクを個別に実行することをお勧めします。

### ソリューションをテストする

1. Azure Portal で、最近作成したリソース グループに移動すると、3 つのリソース (Ap Service、App Service プラン、Container Registry) が表示されます。

1. App Service に移動して **[参照]** を選ぶと、Web サイトに移動します。

1. eShopOnWeb アプリケーションが正常に実行されていることを確認します。 確認したら、ラボは正常に終了します。

## リソースをクリーンアップする

ラボを終えたら、不要な料金が発生しないように Azure リソースをクリーンアップすることが重要です。

### Azure リソースを削除する

1. Azure portal (`https://portal.azure.com`) で **[リソース グループ]** セクションに移動します。
1. **AZ400-RG1** リソース グループ (またはご自分で使った名前) を見つけて選びます。
1. [リソース グループ] ページで、**[リソース グループの削除]** を選択します。
1. リソース グループ名を入力して削除を確認し、**[削除]** を選びます。
1. 削除プロセスが完了するまで待ちます。

### Azure DevOps リソースをクリーンアップする

Azure DevOps 組織またはプロジェクトは参照およびポートフォリオ アイテムとして引き続き使用できるので、これらをクリーンアップする必要はありません。 Azure DevOps では、小規模なチーム向けの基本的な機能を含む Free レベルを使用できます。

プロジェクトを削除したい場合は、次の手順に従って行えます。

1. ブラウザーで Azure DevOps ポータル (`https://aex.dev.azure.com`) に移動します。
1. 作成した **eShopOnWeb** プロジェクトに移動します。
1. プロジェクト設定ページで **[概要]** に移動し、ページの下部にある **[削除]** を選びます。
1. プロジェクト名を入力して削除を確認し、**[削除]** を選びます。

> **注:** プロジェクトを削除すると、すべての作業項目、リポジトリ、ビルド、その他のプロジェクト成果物が削除されます。 この演習用に既存のプロジェクトを使った場合は、この演習の範囲外にある既存のリソースも削除されます。

> **重要**:不要な料金が発生しないように、Azure リソースを必ず削除してください。 Azure DevOps プロジェクトをご自分のポートフォリオの一部として残してもかまいません。

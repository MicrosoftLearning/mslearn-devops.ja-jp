---
lab:
  topic: Intermediate
  title: 機能テストの設定と実行
  description: 単体テスト、統合テスト、機能テストを含む、.NET アプリケーション用の CI パイプラインを構成する方法を学びます。
---

# 機能テストの設定と実行

単体テスト、統合テスト、機能テストを含む、.NET アプリケーション用の CI パイプラインを構成する方法を学びます。 さまざまな種類の自動テストと、それらが継続的インテグレーション戦略にどのように適合するかを理解します。

このラボの所要時間は約 **20** 分です。

## 開始する前に

必要なもの:

- **Microsoft Edge** または [Azure DevOps 対応ブラウザー](https://docs.microsoft.com/azure/devops/server/compatibility)
- **Azure DevOps 組織:** お持ちでない場合は、[組織またはプロジェクト コレクションの作成](https://docs.microsoft.com/azure/devops/organizations/accounts/create-organization)に関する記事を参考にして作成してください

## ソフトウェアのテストについて

変更に対応するとき、複雑なソフトウェアには予想外のエラーが発生することがあります。 変更を行った後のテストは、最も些細なアプリケーションを除くすべてのアプリケーションで必要です。 手動テストはソフトウェアのテスト方法として最も遅く、信頼性がなく、高額です。

ソフトウェア アプリケーションでは、さまざまな種類のテストが自動化されています。

- **単体テスト:** アプリケーションのロジックの 1 つの部分をテストします。 コードが依存関係やインフラストラクチャとどのように連携するかはテストしません
- **統合テスト:** コードが依存関係やインフラストラクチャとどのように連携するかをテストします。 依存関係が完全に解決されたときに、コードのレイヤーが意図したとおりに相互作用することを確認します
- **機能テスト:** ユーザーの観点から書かれており、その要件に基づいてシステムの正確性を検証します

テストの種類について詳しくは、「[ASP.NET Core MVC アプリのテスト](https://learn.microsoft.com/dotnet/architecture/modern-web-apps-azure/test-asp-net-core-mvc-apps)」をご覧ください。

## チーム プロジェクトを作成して構成する

まず、このラボ用の Azure DevOps プロジェクトを作成します。

1. ブラウザーで、Azure DevOps 組織を開きます
1. **[新しいプロジェクト]** を選択します
1. プロジェクトに **eShopOnWeb** という名前を付けます
1. 他のフィールドは既定値のままにしておきます
1. **[作成]** を選択します

## eShopOnWeb Git リポジトリをインポートする

次に、アプリケーション コードとテスト プロジェクトを含むサンプル リポジトリをインポートします。

1. Azure DevOps 組織下で **eShopOnWeb** プロジェクトを開きます
1. **[リポジトリ] > [ファイル]** を選択します
1. **[リポジトリのインポート]** を選択します
1. **インポート** を選択する
1. **[Git リポジトリのインポート]** ウィンドウに、次の URL を貼り付けます: `https://github.com/MicrosoftLearning/eShopOnWeb.git`
1. **インポート** を選択する

リポジトリは次のように構成されています。

- **.ado** フォルダーには、Azure DevOps の YAML パイプラインが含まれています
- **.devcontainer** フォルダーには、コンテナーを使用して開発するためのセットアップが含まれています
- **infra** フォルダーには、Bicep と ARM のコードとしてのインフラストラクチャのテンプレートが含まれています
- **.github** フォルダーには、YAML GitHub ワークフローの定義が含まれます
- **src** フォルダーには、ラボ シナリオで使われる .NET Web サイトが含まれます
- **tests** フォルダーには、さまざまなテスト プロジェクト (単体、統合、機能) が含まれます

1. **[リポジトリ] > [ブランチ]** に移動します
1. **main** ブランチにカーソルを合わせ、右側の省略記号を選択します
1. **[既定のブランチとして設定]** を選択します

## CI パイプラインでテストを設定する

さまざまな種類のテストを含む CI パイプラインを構成します。

### CI 用の YAML ビルド定義をインポートする

継続的インテグレーションを実装する YAML ビルド定義を追加します。

1. **[パイプライン] - [パイプライン]** に移動します
1. **[新しいパイプライン]** (または、パイプラインがない場合は **[パイプラインを作成する]**) を選びます
1. **[Azure Repos Git (YAML)]** を選びます
1. **eShopOnWeb** リポジトリを選びます
1. **[既存の Azure Pipelines の YAML ファイル]** を選択します
1. **main** ブランチと **/.ado/eshoponweb-ci.yml** ファイルを選択します
1. **[続行]** を選択します

CI の定義は以下のタスクで構成されます。

- **DotNet Restore:** プロジェクトのすべての依存関係を、ソース管理に格納しないでインストールします
- **DotNet Build:** プロジェクトとそのすべての依存関係をビルドします
- **DotNet Test:** 単体テストの実行に使われる .Net テスト ドライバー
- **DotNet Publish:** アプリケーションとその依存関係を、デプロイ用のフォルダーに発行します
- **Publish Artifact - Website:** アプリ成果物を発行し、パイプライン成果物として使用できるようにします
- **Publish Artifact - Bicep:** インフラストラクチャ成果物を発行し、パイプライン成果物として使用できるようにします

1. (**[保存して実行]** ではなく) **[保存]** ボタンを選んで、パイプライン定義を保存します

**[保存]** ボタンは、**[保存して実行]** ボタンの右側にある矢印を選ぶと表示されます。

### CI パイプラインにテストを追加する

統合および機能テストを CI パイプラインに追加します。 単体テストはパイプラインに既に含まれることに注意してください。

1. **[編集]** ボタンを選んでパイプラインを編集します
1. 単体テスト タスクの後に統合テスト タスクを追加します。

   ```yaml
   - task: DotNetCoreCLI@2
     displayName: Integration Tests
     inputs:
       command: "test"
       projects: "tests/IntegrationTests/*.csproj"
   ```

   **統合テスト**では、コードが依存関係またはインフラストラクチャとどのように連動するかをテストします。 データベースやファイル システムなどのインフラストラクチャとやり取りするコードをカプセル化するのはよいことですが、それでもそのようなコードは残るので、それをテストする必要があります。 さらに、アプリケーションの依存関係が完全に解決されたときにコードのレイヤーが想定どおりに相互作用することを検証する必要があります。

1. 統合テスト タスクの後に、機能テスト タスクを追加します。

   ```yaml
   - task: DotNetCoreCLI@2
     displayName: Functional Tests
     inputs:
       command: "test"
       projects: "tests/FunctionalTests/*.csproj"
   ```

   **機能テスト**はユーザーの観点から書かれており、その要件に基づいてシステムの正確性を検証します。 コンポーネントが正しく連携していることを検証するために開発者の観点から書かれた統合テストとは異なり、機能テストではエンド ユーザーの観点からシステムの動作を検証します。

1. **[検証して保存]** を選びます
1. 検証が成功した場合は、**[保存]** をもう一度選んで、変更をメイン ブランチに直接コミットします

### テストの概要を確認する

ここでは、パイプラインを実行して、テスト結果を調べます。

1. **[実行]** を選択します
1. **[パイプラインの実行]** タブで、もう一度 **[実行]** を選びます
1. パイプラインが開始してビルド ステージが正常に完了するまで待ちます
1. 完了すると、パイプライン実行の一部として **[テスト]** タブが表示されます
1. それを選んで概要を確認します

   ![テストの概要のスクリーンショット](media/AZ400_M05_L09_Tests_Summary.png)

1. ページの下部にあるテーブルに、さまざまな実行テストの詳細なリストが示されています

   ![テスト テーブルのスクリーンショット](media/AZ400_M05_L09_Tests_Table.png)

> **注**:テーブルが空の場合は、フィルターをリセットして、テストの実行に関するすべての詳細が示されるようにする必要があります。

## トラブルシューティング

### 機能テストの失敗

機能テストを実行すると次のエラーが発生する場合:

```
System.IO.FileNotFoundException : Could not load file or assembly 'Microsoft.Extensions.Configuration.Abstractions, Version=9.0.0.0, Culture=neutral, PublicKeyToken=adb9793829ddae60'. The system cannot find the file specified.
```

このエラーは、eShopOnWeb リポジトリの依存関係でバージョンが一致していないために発生します。 このプロジェクトの対象は .NET 8.0 ですが、一部のパッケージで .NET 9.0 のアセンブリが参照されています。

**回避策のオプション:**

1. **機能テストをスキップする (ラボを完了する場合に推奨):** パイプラインを変更して機能テストを除外し、単体と統合テストのみを実行してラボの目標を完了します。

1. **手動での修正:** リポジトリをインポートした後、`Directory.Packages.props` ファイルを人手で編集して、競合するパッケージをダウングレードできます。
   - `Microsoft.EntityFrameworkCore.Tools` をバージョン `9.0.4` から `8.0.8` に変更します
   - `System.Text.Json` をバージョン `9.0.4` (または `9.0.2`) から `8.0.1` に変更します

## まとめ

このラボでは、Azure Pipelines と .NET を使ってさまざまなテストの種類を設定して実行する方法を学びました。 次のものを含む CI パイプラインを構成しました。

- **単体テスト:** 個々のコンポーネントを個別にテスト
- **統合テスト:** コンポーネントと依存関係の連携のテスト
- **機能テスト:** ユーザーの観点からのシステムのテスト

これらのさまざまなテスト レイヤーによって、包括的なカバレッジが提供され、開発ライフサイクル全体でのコード品質の保証に役立ちます。 CI/CD パイプラインでの自動テストは、問題を早期に把握し、デプロイの信頼性を保つのに役立ちます。

---
lab:
  topic: Intermediate
  title: Azure Artifacts によるパッケージ管理
  description: フィードの作成と接続、NuGet パッケージの発行など、パッケージ管理のために Azure Artifacts を操作する方法について説明します。
---

# Azure Artifacts によるパッケージ管理

**推定所要時間:** 35 分

フィードの作成と接続、NuGet パッケージの作成と発行、NuGet パッケージのインポート、NuGet パッケージの更新など、パッケージ管理のために Azure Artifacts を操作する方法について説明します。 Azure Artifacts により、Azure DevOps での NuGet、npm、Maven パッケージの検出、インストール、発行は容易になります。

## 開始する前に

必要なもの:

- **Microsoft Edge** または [Azure DevOps 対応ブラウザー](https://docs.microsoft.com/azure/devops/server/compatibility)
- **Azure DevOps 組織:** お持ちでない場合は作成してください
- **Visual Studio 2022 Community Edition** は [Visual Studio のダウンロード ページ](https://visualstudio.microsoft.com/downloads/)から入手できます。 インストールには次のものが含まれます。
  - **ASP.NET および Web の開発**ワークロード
  - **Azure 開発**ワークロード
  - **.NET Core クロスプラットフォームの開発**ワークロード
- **.NET Core SDK:**[.NET Core SDK (2.1.400 以降) をダウンロードしてインストールします](https://go.microsoft.com/fwlink/?linkid=2103972)
- **Azure Artifacts 資格情報プロバイダー:**[資格情報プロバイダーをダウンロードしてインストールする](https://go.microsoft.com/fwlink/?linkid=2099625)

## Azure Artifacts の概要

Azure Artifacts は、Azure DevOps での NuGet、npm、Maven パッケージの検出、インストール、公開を容易にします。 ビルドなどの他の Azure DevOps 機能と緊密に統合されているため、パッケージ管理は既存のワークフローのシームレスな部分になります。

主な利点:

- 組織全体での**パッケージの一元管理**
- **CI/CD パイプラインとの統合**による自動パッケージ発行
- **複数のパッケージの種類をサポート** (NuGet、npm、Maven、Python、ユニバーサル パッケージ)
- **アップストリーム ソース**による、パブリック リポジトリからパッケージのプロキシおよびキャッシュ
- パッケージへのアクセスを制御する**セキュリティとアクセス許可**

## チーム プロジェクトを作成して構成する

まず、このラボ用の Azure DevOps プロジェクトを作成します。

1. ブラウザーで、Azure DevOps 組織を開きます
1. **[新しいプロジェクト]** を選択します
1. プロジェクトに **eShopOnWeb** という名前を付けます
1. 他のフィールドは既定値のままにします
1. **[作成]** を選択します

## eShopOnWeb Git リポジトリをインポートする

次に、アプリケーション コードを含むサンプル リポジトリをインポートします。

1. Azure DevOps 組織で、**eShopOnWeb** プロジェクトを開きます
1. **[リポジトリ] > [ファイル]** を選択します
1. **[リポジトリのインポート]** を選択します
1. **インポート** を選択する
1. **[Git リポジトリのインポート]** ウィンドウに、次の URL を貼り付けます: `https://github.com/MicrosoftLearning/eShopOnWeb.git`
1. **インポート** を選択する

リポジトリは次のように構成されています。

- **.ado** フォルダーには、Azure DevOps の YAML パイプラインが含まれています
- **src** フォルダーには、ラボ シナリオで使用される .NET 8 Web サイトが含まれています

1. **[リポジトリ] > [ブランチ]** に移動します
1. **main** ブランチにカーソルを合わせ、右側の省略記号を選択します
1. **[既定のブランチとして設定]** を選択します

## Visual Studio で eShopOnWeb ソリューションを構成する

ラボの準備として Visual Studio を構成します。

1. Azure DevOps ポータルで **eShopOnWeb** チーム プロジェクトを表示していることを確認します

> **注**:https://dev.azure.com/`<your-Azure-DevOps-account-name>`/eShopOnWeb URL に移動すると、プロジェクト ページに直接アクセスできます。この `<your-Azure-DevOps-account-name>` プレースホルダーは Azure DevOps 組織名を表します。

1. **eShopOnWeb** ペインの左側にある縦型メニューで、**[リポジトリ]** を選択します
1. **[ファイル]** ペインで **[クローン]** を選択します
1. **[VS Code でクローン]** の横にあるドロップダウン矢印を選択し、ドロップダウン メニューで **[Visual Studio]** を選択します
1. 続行するかどうかを確認されたら、**[開く]** を選択します
1. プロンプトが表示されたら、Azure DevOps 組織のセットアップに使用したユーザー アカウントでサインインします
1. Visual Studio インターフェイス内の **Azure DevOps** ポップアップ ウィンドウで、既定のローカル パス (C:\eShopOnWeb) をそのままにして、**[クローン]** を選択します
1. これにより、プロジェクトが Visual Studio に自動的にインポートされます
1. ラボで使用するために、Visual Studio ウィンドウを開いたままにします

## Azure Artifacts の操作

以下の手順で Azure Artifacts を操作する方法について説明します。

- フィードを作成して接続する
- NuGet パッケージを作成して発行する
- NuGet パッケージをインポートする
- NuGet パッケージを更新する

### フィードを作成して接続する

フィードはパッケージのコレクションです。 NuGet パッケージを保存するフィードを作成します。

1. Azure DevOps プロジェクトを表示する Web ブラウザー ペインの縦型ナビゲーション ウィンドウで、**[アーティファクト]** アイコンを選択します
1. **[アーティファクト]** ハブが表示されている状態で、ペインの上部にある **[+ フィードの作成]** を選択します

> **注**:このフィードは、組織内のユーザーが利用できる NuGet パッケージのコレクションであり、ピアとしてパブリック NuGet フィードと並んで配置されます。

1. **[新しいフィードの作成]** ペインの **[名前]** テキストボックスに「**eShopOnWebShared**」と入力します
1. **[表示設定]** セクションで **[自分の所属組織内のユーザー]** を選択します
1. **[アップストリーム ソース]** セクションで、**[共通のパブリック ソースからのパッケージを含める]** を選択します
1. **[作成]** を選択します

> **注**:このNuGet フィードに接続するユーザーは、環境を構成する必要があります。

1. **[アーティファクト]** ハブに戻り、**[フィードに接続する]** を選択します
1. **[フィードに接続]** ペインの **NuGet** セクションで、**[Visual Studio]** を選択し、**[ソース]** の URL をコピーします
1. **Visual Studio** ウィンドウに戻ります
1. Visual Studio ウィンドウで、**[ツール]** メニュー ヘッダーを選択し、ドロップダウン メニューで **[NuGet Package Manager]** を選択し、カスケード メニューで **[パッケージ マネージャー設定]** を選択します
1. **[オプション]** ダイアログ ボックスで、**[パッケージ ソース]** を選択し、プラス記号を選択して新しいパッケージ ソースを追加します
1. ダイアログ ボックスの下部にある **[名前]** テキストボックスで「**パッケージ ソース**」を「**eShopOnWebShared**」に置き換えます
1. **[ソース]** テキストボックスに、Azure DevOps からコピーした URL を貼り付けます
1. **[更新]**、**[OK]** の順に選択します

> **注**:Visual Studio が新しいフィードに接続されました。

### NuGet パッケージを作成して発行する

カスタムの NuGet パッケージを作成してフィードに発行します。

1. 新しいパッケージソースの構成に使用した Visual Studio ウィンドウで、メイン メニューの **[ファイル]** を選択し、ドロップダウン メニューの **[新規]** を選択してから、カスケード メニューの **[プロジェクト]** を選択します
1. **[新しいプロジェクト]** ダイアログ ボックスの **[新しいプロジェクトの作成]** ペインで、プロジェクト テンプレートの一覧から **[クラス ライブラリ]** テンプレートを探し、**[クラス ライブラリ (.NET Standard)]** テンプレートを選択して、**[次へ]** を選択します
1. **[新しいプロジェクト]** ダイアログ ボックスの **[新しいプロジェクトの構成]** ペインで、次の設定を指定して **[作成]** を選択します。

   - プロジェクト名: **eShopOnWeb.Shared**
   - 場所: 既定値のままにします
   - 解答:**新しいソリューションの作成**
   - ソリューション名: **eShopOnWeb.Shared**

1. **[その他の情報]** ダイアログ ボックスで、フレームワーク **[.NET 8.0 (長期サポート)]** を選択し、**[作成]** を選択します。
1. Visual Studio インターフェイスの **[ソリューション エクスプローラー]** ペインで **Class1.cs** を右クリックし、右クリック メニューで **[削除]** を選択し、確認を求められたら **[OK]** を選択します
1. **Ctrl + Shift + B** キーを押すか、**eShopOnWeb.Shared プロジェクトを右クリック**して **[ビルド]** を選択し、プロジェクトをビルドします

> **注**:次に、MSBuild を使用してプロジェクトから直接 NuGet パッケージを生成します。 このアプローチは、共有ライブラリにパッケージ内のすべてのメタデータと依存関係を含める場合に一般的です。

1. Azure DevOps Web ポータルに切り替えて、**[アーティファクト]** セクションに移動します
1. **eShopOnWebShared** フィードを選択します
1. **[フィードに接続する]** を選択し、**[NuGet]** セクションの **NuGet.exe** を選択します
1. 後で使用するために、**[プロジェクトの設定]** コマンドをコピーします

### dotnet CLI を使用してパッケージを発行する

.NET CLI を使用してパッケージをパックし、発行します。

1. Visual Studio で、**eShopOnWeb.Shared** プロジェクトを右クリックし、**[エクスプローラーでフォルダーを開く]** を選択します
1. エクスプローラー ウィンドウで、プロジェクト フォルダーのパスをメモします
1. 管理者として**コマンド プロンプト**または **PowerShell** ウィンドウを開きます
1. `cd` コマンドを使用してプロジェクト フォルダーに移動します
1. 次のコマンドを実行して NuGet パッケージを作成します。

   ```
   dotnet pack --configuration Release
   ```

1. これにより、`bin\Release` フォルダーに `.nupkg` ファイルが作成されます
1. `bin\Release` フォルダーに移動します。

   ```
   cd bin\Release
   ```

1. パッケージを Azure Artifacts フィードに発行する必要があります。 まず、パッケージ ソースを追加します。

   ```
   dotnet nuget add source "YOUR_FEED_URL" --name "eShopOnWebShared" --username "YOUR_USERNAME" --password "YOUR_PAT"
   ```

> **注**:YOUR_FEED_URL を Azure DevOps のフィード URL に、YOUR_USERNAME を Azure DevOps ユーザー名に、YOUR_PAT をパッケージの読み取り/書き込みアクセス許可を持つ個人用アクセス トークンに置き換えます。

1. パッケージを公開してください。

   ```
   dotnet nuget push *.nupkg --source "eShopOnWebShared"
   ```

1. Azure DevOps Web ポータルに戻り、**[アーティファクト]** タブを表示します
1. **[更新]** を選択します
1. パッケージの一覧から **eShopOnWeb.Shared** パッケージを選択します
1. **eShopOnWeb.Shared** ペインでメタデータを確認します

### NuGet パッケージをインポートする

次は、作成したパッケージを別のプロジェクトにインポートします。

1. Visual Studio に戻ります
1. **ソリューション エクスプローラー**で **eShopOnWeb.Shared** ソリューションを右クリックし、**[追加] > [新しいプロジェクト]** を選択します
1. **[コンソール アプリ (.NET Core)]** テンプレートを選択し、**[次へ]** を選択します
1. プロジェクトを構成します。
   - プロジェクト名: **eShopOnWeb.Shared.Client**
   - 場所: 既定値のままにします
   - 解答:**ソリューションに追加する**
1. **[作成]** を選択します
1. **ソリューション エクスプローラー**で **eShopOnWeb.Shared.Client** プロジェクトを右クリックし、**[NuGet パッケージの管理]** を選択します
1. **NuGet パッケージ マネージャー** ペインで、**[参照]** タブを選択します
1. **[パッケージ ソース]** ドロップダウンから **eShopOnWebShared** を選択します
1. 検索ボックスに「**eShopOnWeb.Shared**」と入力して Enter キーを押します
1. **eShopOnWeb.Shared** パッケージを選択し、**[インストール]** を選択します
1. プロンプトが表示されたら使用許諾契約に同意します
1. これでパッケージがインストールされ、プロジェクトで使用できるようになりました

### NuGet パッケージを更新する

元のプロジェクトを変更し、新しいバージョンを発行することで、パッケージを更新します。

1. **ソリューション エクスプローラー**で、**eShopOnWeb.Shared** プロジェクトを右クリックし、**[追加] > [クラス]** を選択します
1. クラスに「**ProductHelper**」という名前を付け、**[追加]** を選択します
1. クラスに次のサンプル コードを追加します。

   ```csharp
   using System;

   namespace eShopOnWeb.Shared
   {
       public class ProductHelper
       {
           public static string GetProductDisplayName(string name, decimal price)
           {
               return $"{name} - ${price:F2}";
           }
       }
   }
   ```

1.  ファイルを保存します
1. **eShopOnWeb.Shared** プロジェクトを右クリックし、**[プロパティ]** を選択します
1. **[パッケージ]** タブの **[パッケージ バージョン]** を 1.0.0 から 1.1.0 に増やします
1. 保存してプロパティ ウィンドウを閉じます
1. **Ctrl+Shift+B** キーを押してプロジェクトをビルドします
1. 管理者としてコマンド プロンプトまたは PowerShell をもう一度開きます
1. **eShopOnWeb.Shared** プロジェクト フォルダーに移動します
1. 新しいバージョンをパックします。

    ```
    dotnet pack --configuration Release
    ```

1. `bin\Release` フォルダーに移動して新しいバージョンを発行します。

    ```
    dotnet nuget push *.nupkg --source "eShopOnWebShared"
    ```

1. Azure DevOps Web ポータルに戻ります
1. **eShopOnWeb.Shared** パッケージ ページを更新します
1. バージョン 1.1.0 が使用可能になっているはずです

### クライアント プロジェクトのパッケージを更新します

1. Visual Studio に戻ります
1. **ソリューション エクスプローラー**で **eShopOnWeb.Shared.Client** プロジェクトを右クリックし、**[NuGet パッケージの管理]** を選択します
1. **[更新]** タブを選択します
1. **eShopOnWeb.Shared** に適用できる更新プログラムがあることがわかります
1. パッケージを選択し、**[更新]** を選択します
1. プロンプトが表示されたら使用許諾契約に同意します
1. これでパッケージは最新バージョンに更新されました

## まとめ

このラボでは、次の方法で Azure Artifacts を操作する方法を学びました。

- パッケージを一元管理するための**フィードの作成と接続**
- .NET CLI を使用した **NuGet パッケージの作成と発行**
- **NuGet パッケージの別のプロジェクトへのインポート**
- 新しいバージョンと機能での **NuGet パッケージの更新**

Azure Artifacts は、組織全体でパッケージを管理し、CI/CD パイプラインや開発ワークフローとシームレスに統合するための強力なプラットフォームを提供します。 複数のパッケージ形式をサポートし、外部パッケージ リポジトリをプロキシするためのアップストリーム ソース機能を提供します。

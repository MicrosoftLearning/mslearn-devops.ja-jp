---
lab:
  topic: Intermediate
  title: Azure Pipelines を使用した継続的インテグレーションを有効にする
  description: pull request の検証と継続的インテグレーションの実装に YAML を使って、Azure DevOps でビルド パイプラインを定義する方法を学びます。
---

# Azure Pipelines を使用した継続的インテグレーションを有効にする

このラボでは、YAML を使って Azure DevOps でビルド パイプラインを定義する方法を学びます。 パイプラインは、pull request 検証プロセスの一部として、および継続的インテグレーションの実装の一部としての、2 つのシナリオで使われます。

学習内容:

- ビルド検証を Pull Request の一部として含めます。
- YAML を使用して CI パイプラインをコードとして構成します。
- コード保護のためのブランチ ポリシーを設定します。
- pull request と自動ビルドについての作業を行います。

このラボの所要時間は約 **30** 分です。

## 開始する前に

このラボを終えるには、次のものが必要です。

- **Microsoft Edge** または [Azure DevOps 対応ブラウザー](https://docs.microsoft.com/azure/devops/server/compatibility)。
- Azure DevOps 組織。 まだない場合は、[組織またはプロジェクト コレクションの作成](https://docs.microsoft.com/azure/devops/organizations/accounts/create-organization)に関する記事の手順に従って作成します。

### Azure DevOps 組織を設定する (必要な場合)

Azure DevOps 組織がまだない場合は、次の手順のようにします。

1. プライベート ブラウザー セッションを使って、`https://account.microsoft.com` で新しい**個人用 Microsoft アカウント (MSA)** を取得します (既にお持ちの場合はスキップしてください)。
1. 同じブラウザー セッションを使って、`https://azure.microsoft.com/free` で無料の Azure サブスクリプションにサインアップします (既にお持ちの場合はスキップしてください)。
1. ブラウザーを開き、`https://portal.azure.com` の Azure portal に移動し、Azure portal 画面の上部で **Azure DevOps** を検索します。 表示されたページで、**[Azure DevOps 組織]** を選びます。
1. 次に、**[自分の Azure DevOps 組織]** というラベルの付いたリンクを選ぶか、`https://aex.dev.azure.com` に直接移動します。
1. **[We need a few more details](詳細情報をいくつか入力する必要があります)** ページで、 **[続行]** を選びます。
1. 左側のドロップダウン ボックスで、**Microsoft アカウント**の代わりに **[既定のディレクトリ]** を選びます。
1. [詳細情報をいくつか入力する必要があります] というメッセージが表示されたら、名前、メール アドレス、場所を入力して、**[続行]** を選びます。__
1. **[既定のディレクトリ]** を選んで `https://aex.dev.azure.com` に戻り、青い **[新しい組織の作成]** ボタンを選びます。
1. **[続行]** を選んで "サービス使用条件" を承諾します。__
1. プロンプト ( _[Almost done](ほぼ完了)_ ) が表示されたら、Azure DevOps 組織の名前を既定のままにし (グローバルに一意の名前である必要があります)、一覧から最寄りのホスティング場所を選びます。
1. 新しく作成した組織が **Azure DevOps** で開いたら、左下隅にある **[組織設定]** を選びます。
1. **[組織設定]** 画面で、**[課金情報]** を選びます (この画面を開くには数秒かかります)。
1. **[課金の設定]** を選び、画面の右側で **[Azure サブスクリプション]**、**[保存]** の順に選んでサブスクリプションを組織にリンクします。
1. 画面の上部にリンクされた Azure サブスクリプション ID が表示されたら、**MS Hosted CI/CD** の**有料並列ジョブ**の数を 0 から **1** に変更します。 次に、下部にある **[保存]** を選びます。

   > **注**: **CI/CD 機能を使用する前に数分間待つ**と、新しい設定がバックエンドに反映されます。 それができなかった場合、 _"ホストされた並列処理は購入も許可もされていません"_ というメッセージが依然として表示されます。

1. **[組織の設定]** の **[パイプライン]** セクションに移動して、**[設定]** を選びます。
1. **[クラシック ビルド パイプラインの作成を無効にする]** と **[クラシック リリース パイプラインの作成を無効にする]** を **[オフ]** に切り替えます。
1. **[組織の設定]** で、**[セキュリティ]** セクションに移動して **[ポリシー]** を選びます。
1. **[パブリック プロジェクトを許可します]** を **[オン]** に切り替えます。

### Azure DevOps プロジェクトを作成して構成する (必要な場合)

1. ブラウザーを開き、Azure DevOps 組織に移動します。
1. **[新しいプロジェクト]** オプションを選び、次の設定を使用します。
   - 名前: **eShopOnWeb**
   - 可視性: **プライベート**
   - 詳細設定: バージョン コントロール: **Git**
   - 詳細設定: 作業項目プロセス: **スクラム**
1. **［作成］** を選択します

### eShopOnWeb Git リポジトリをインポートする (必要な場合)

1. 前に作成した **eShopOnWeb** プロジェクトを開きます。
1. **[Repos] > [ファイル]** を選び、**[リポジトリをインポートする]**、**[インポート]** の順に選びます。
1. **[Git リポジトリをインポートする]** ウィンドウで、URL `https://github.com/MicrosoftLearning/eShopOnWeb.git` を貼り付けて、**[インポート]** を選びます。

1. リポジトリは次のように編成されています。

   - **.ado** フォルダーには、Azure DevOps の YAML パイプラインが含まれています。
   - **.devcontainer** フォルダーには、コンテナーを使って開発するためのセットアップが含まれています (VS Code でローカルに、または GitHub Codespaces で)。
   - **infra** フォルダーには、一部のラボ シナリオで使用される Bicep および ARM のコードとしてのインフラストラクチャ テンプレートが含まれています。
   - **.github** フォルダーには、YAML GitHub ワークフローの定義が含まれています。
   - **src** フォルダーには、ラボ シナリオで使用される .NET Web サイトが含まれています。

1. Web ブラウザーのウィンドウは開いたままにしておきます。
1. **[リポジトリ]、[ブランチ]** に移動します。
1. **メイン** ブランチをポイントし、列の右側にある省略記号を選びます。
1. **[既定のブランチとして設定]** を選びます。

## ビルド検証を Pull Request の一部として含める

このセクションでは、pull request を検証するためのビルド検証を組み込みます。

### YAML ビルド定義をインポートする

このタスクでは、pull request を検証するためにブランチ ポリシーとして使われる YAML ビルド定義をインポートします。

まず、[eshoponweb-ci-pr.yml](https://github.com/MicrosoftLearning/eShopOnWeb/blob/main/.ado/eshoponweb-ci-pr.yml) というビルド パイプラインをインポートします。

1. **[パイプライン] - [パイプライン]** に移動します
1. **[パイプラインの作成]** または **[新しいパイプライン]** ボタンを選びます
1. **[Azure Repos Git (YAML)]** を選びます
1. **eShopOnWeb** リポジトリを選びます
1. **[既存の Azure Pipelines の YAML ファイル]** を選択します
1. **メイン** ブランチと **/.ado/eshoponweb-ci-pr.yml** ファイルを選んでから、**[続行]** を選びます

   ビルドの定義は以下のタスクで構成されます。

   - **DotNet Restore**: NuGet パッケージの復元を使うと、ソース管理に格納しなくても、プロジェクトのすべての依存関係をインストールできます。
   - **DotNet Build**: プロジェクトとそのすべての依存関係をビルドします。
   - **DotNet Test**: 単体テストの実行に使われる .Net テスト ドライバー。
   - **DotNet Publish**: ホスティング システムへのデプロイ用のフォルダーに、アプリケーションとその依存関係を発行します。 この場合は、**Build.ArtifactStagingDirectory** です。

1. **[パイプライン YAML をレビューする]** ペインで、**[実行]** ボタンの横にある下向きのキャレット記号を選んで、**[保存]** を選びます。
1. パイプラインには、プロジェクト名に基づく名前が付けられます。 パイプラインを識別しやすくするために、**名前を変更**しましょう。 **[パイプライン] > [パイプライン]** に移動し、先ほど作成したパイプラインを選びます。 省略記号を選んで、**[名前の変更/移動]** オプションを選びます。 それに **eshoponweb-ci-pr** という名前を付けて、**[保存]** を選びます。

### ブランチ ポリシー

このタスクでは、メイン ブランチにポリシーを追加し、定義されているポリシーに準拠する pull request を使った変更のみを許可します。 ブランチの変更を確認してから、マージする必要があります。

1. **[リポジトリ] - [ブランチ]** セクションに移動します。
1. **[ブランチ]** ペインの **[マイニング]** タブで、**main** ブランチ エントリにマウス ポインターを合わせると、右側に省略記号が表示されます。
1. 省略記号を選び、ポップアップ メニューで **[ブランチ ポリシー]** を選びます。
1. リポジトリ設定の **[main]** タブで、 **[Require minimum number of reviewers] (レビュー担当者の最小数を必須にする)** のオプションを有効にします。 **1** 人のレビュー担当者を追加し、 **[Allow requestors to approve their own changes] (要求者が自分の変更を承認することを許可する)** チェック ボックスをオンにします (このラボのプロジェクトでは、自分が唯一のユーザーであるため)
1. リポジトリ設定の **[メイン]** タブの **[ビルド検証]** セクションで、**[+]** (新しいビルド ポリシーの追加) を選び、**[ビルド パイプライン]** の一覧で **eshoponweb-ci-pr** を選んで、**[保存]** を選びます。

### pull request の操作

このタスクでは、Azure DevOps ポータルを使い、保護された **main** ブランチに変更をマージする新しいブランチを使って、pull request を作成します。

1. eShopOnWeb のナビゲーションで **[リポジトリ]** セクションに移動し、**[ブランチ]** を選びます。
1. **main** ブランチに基づいて **Feature01** という名前の新しいブランチを作成します。
1. **Feature01** を選び、**Feature01** ブランチの一部である **/eShopOnWeb/src/Web/Program.cs** ファイルに移動します
1. 右上の **[編集]** ボタンを選びます
1. 1 行目を次のように変更します。

   ```csharp
   // Testing my PR
   ```

1. **[コミット] > [コミット]** を選びます (既定のコミット メッセージのままにします)。
1. メッセージがポップアップ表示され、pull request を作成するように提案されます (**Feature01** ブランチは **main** と比較して変更が進んでいるため)。 **[pull request の作成]** を選びます。
1. **[新しい pull request ]** タブで、既定値のままにして **[作成]** を選びます。
1. pull request では、ターゲットの **main** ブランチに適用されているポリシーに基づいて、保留中の要求がいくつか示されます。

   - 少なくとも 1 人のユーザーが変更を確認し、承認する必要があります。
   - ビルド検証では、ビルド **eshoponweb-ci-pr** が自動的にトリガーされたことがわかります

1. すべての検証が成功したら、右上の **[承認]** を選びます。 これで、**[オートコンプリートの設定]** ドロップダウンから、**[完了]** を選択できます。
1. **[pull request の完了]** タブで、**[マージの完了]** を選びます

## YAML を使用してコードとしての CI パイプラインを構する

このセクションでは、YAML を使ってコードとしての CI パイプラインを構成します。

### CI 用の YAML ビルド定義をインポートする

このタスクでは、継続的インテグレーションの実装に使う YAML ビルド定義を追加します。

まず、[eshoponweb-ci.yml](https://github.com/MicrosoftLearning/eShopOnWeb/blob/main/.ado/eshoponweb-ci.yml) という CI パイプラインをインポートします。

1. **[パイプライン] > [パイプライン]** に移動します。
1. **[新しいパイプライン]** ボタンを選びます。
1. **[Azure Repos Git (YAML)]** を選びます。
1. **eShopOnWeb** リポジトリを選びます。
1. **[既存の Azure Pipelines YAML ファイル]** を選びます。
1. **メイン** ブランチと **/.ado/eshoponweb-ci.yml** ファイルを選んでから、**[続行]** を選びます。

   CI の定義は以下のタスクで構成されます。

   - **DotNet Restore**: NuGet パッケージの復元を使うと、ソース管理に格納しなくても、プロジェクトのすべての依存関係をインストールできます。
   - **DotNet Build**: プロジェクトとそのすべての依存関係をビルドします。
   - **DotNet Test**: 単体テストの実行に使われる .Net テスト ドライバー。
   - **DotNet Publish**: ホスティング システムへのデプロイ用のフォルダーに、アプリケーションとその依存関係を発行します。 この場合は、**Build.ArtifactStagingDirectory** です。
   - **成果物の発行 - Web サイト**: (前のステップで作成した) アプリ成果物を発行し、パイプライン成果物として利用できるようにします。
   - **成果物の発行 - Bicep**: インフラストラクチャ成果物 (Bicep ファイル) を発行し、パイプライン成果物として利用できるようにします。

1. **[実行]** を選び、パイプラインが正常に実行されるのを待ちます。

### 継続的インテグレーションを有効にする

既定のビルド パイプライン定義では、継続的インテグレーションは有効になりません。

1. 右上の **[新しい実行]** ボタンの近くにある省略記号メニューで **[パイプラインの編集]** オプションを選びます
1. 次に、 **# trigger:** と **# - main** を次のコードに置き換える必要があります。

   ```YAML
   trigger:
     branches:
       include:
       - main
     paths:
       include:
       - src/web/*
   ```

   これにより、メイン ブランチと Web アプリケーション コード (src/web フォルダー) が変更された場合、ビルド パイプラインが自動的にトリガーされます。

   ブランチ ポリシーを有効にしたので、コードを更新するには pull request を渡す必要があります。

1. **[検証して保存]** ボタンを選び、パイプラインの定義を検証し保存します。
1. **[このコミットのブランチを新規作成]** を選びます。
1. 既定のブランチ名と、オンにされた **[pull request の開始]** をそのままにして。
1. **[保存]** を選択します。
1. パイプラインには、プロジェクト名に基づく名前が付けられます。 パイプラインを識別しやすくするために、**名前を変更**しましょう。 **[パイプライン] > [パイプライン]** に移動し、先ほど作成したパイプラインを選びます。 省略記号を選んで、**[名前の変更/移動]** オプションを選びます。 それに **eshoponweb-ci** という名前を付けて、**[保存]** を選びます。
1. **[リポジトリ] > [pull request]** に移動します。
1. "**Update eshoponweb-ci.yml for Azure Pipelines**" pull request を選びます。
1. すべての検証が成功したら、右上の **[承認]** を選びます。 **[完了]** を選べるようになります。
1. **[pull request の完了]** タブで、**[マージの完了]** を選びます

### CI パイプラインをテストする

このタスクでは、pull request を作成し、新しいブランチを使って保護された **main** ブランチに変更をマージして、CI パイプラインを自動的にトリガーします。

1. **[リポジトリ]** セクションに移動して、**[ブランチ]** を選びます。
1. **main** ブランチに基づいて **Feature02** という名前の新しいブランチを作成します。
1. 新しい **Feature02** ブランチを選びます。
1. **/eShopOnWeb/src/Web/Program.cs** ファイルに移動し、右上の **[編集]** を選びます。
1. 1 行目を削除します。

   ```csharp
   // Testing my PR
   ```

1. **[コミット] > [コミット]** を選びます (既定のコミット メッセージのままにします)。
1. メッセージがポップアップ表示され、pull request を作成するように提案されます (**Feature02** ブランチは **main** と比較して変更が進んでいるため)。
1. **[pull request の作成]** を選びます。
1. **[新しい pull request ]** タブで、既定値のままにして **[作成]** を選びます。
1. pull request では、ターゲットの **main** ブランチに適用されているポリシーに基づいて、保留中の要求がいくつか示されます。
1. すべての検証が成功したら、右上の **[承認]** を選びます。 これで、**[オートコンプリートの設定]** ドロップダウンから、**[完了]** を選択できます。
1. **[pull request の完了]** タブで、**[マージの完了]** を選びます
1. **[パイプライン] - [パイプライン]** に戻ると、コードがマージされた後にビルド **eshoponweb-ci** が自動的にトリガーされたことがわかります。
1. **eshoponweb-ci** ビルドを選んでから、最後の実行を選びます。
1. 正常に実行されたら、**[関連] > [発行済み]** を選んで、発行された成果物を調べます。
   - Bicep: インフラストラクチャ成果物。
   - Web サイト: アプリ成果物。

## リソースをクリーンアップする

Azure DevOps 組織またはプロジェクトは参照およびポートフォリオ アイテムとして引き続き使用できるので、これらをクリーンアップする必要はありません。 Azure DevOps では、小規模なチーム向けの基本的な機能を含む Free レベルを使用できます。

プロジェクトを削除したい場合は、次の手順に従って行えます。

1. ブラウザーで Azure DevOps ポータル (`https://aex.dev.azure.com`) に移動します。
1. 作成した **eShopOnWeb** プロジェクトに移動します。
1. プロジェクト設定ページで **[概要]** に移動し、ページの下部にある **[削除]** を選びます。
1. プロジェクト名を入力して削除を確認し、**[削除]** を選びます。

> **注:** プロジェクトを削除すると、すべての作業項目、リポジトリ、ビルド、その他のプロジェクト成果物が削除されます。 この演習用に既存のプロジェクトを使った場合は、この演習の範囲外にある既存のリソースも削除されます。

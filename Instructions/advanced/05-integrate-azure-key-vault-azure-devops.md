---
lab:
  topic: Advanced
  title: Azure Key Vault を Azure DevOps と統合する
  description: Azure Key Vault と Azure Pipeline を統合して、パスワードやキーなどの機密データを安全に保存および取得する方法を学習します。
---

# Azure Key Vault を Azure DevOps と統合する

**推定所要時間:** 40 分

Azure Key Vault と Azure Pipeline を統合して、パスワードやキーなどの機密データを安全に保存および取得する方法を学習します。 Azure Key Vault を作成し、Azure Container Registry のパスワードをシークレットとして保存し、そのシークレットを取得してコンテナーのデプロイに使用するようにパイプラインを構成します。

## 開始する前に

必要なもの:

- **Microsoft Edge** または [Azure DevOps 対応ブラウザー](https://learn.microsoft.com/azure/devops/server/compatibility)
- **Azure サブスクリプション:** アクティブな Azure サブスクリプションが必要です。または新しいサブスクリプションを作成することもできます
- **Azure DevOps 組織:** お持ちでない場合は、[組織またはプロジェクト コレクションの作成](https://learn.microsoft.com/azure/devops/organizations/accounts/create-organization)に関する記事を参考にして作成してください

## Azure Key Vault について

Azure Key Vault は、キー、パスワード、証明書などの機密データの安全な保管と管理を行います。 Azure Key Vault では、ハードウェア セキュリティ モジュール、およびさまざまな暗号化アルゴリズムとキー長がサポートされています。 Azure Key Vault を使用することで、開発者がよく犯す間違いであるソース コードを介して機密データを開示する可能性を最小限に抑えることができます。 Azure Key Vault にアクセスするには、コンテンツに対するきめ細かいアクセス許可をサポートする適切な認証と認可が必要です。

## チーム プロジェクトを作成して構成する

まず、このラボ用の Azure DevOps プロジェクトを作成します。

1. ブラウザーで、Azure DevOps 組織を開きます
1. **[新しいプロジェクト]** を選択します
1. プロジェクトに **eShopOnWeb** という名前を付けます
1. 他のフィールドは既定値のままにしておきます
1. **[作成]** を選択します

   ![[新しいプロジェクトの作成] パネルのスクリーンショット](media/create-project.png)

## eShopOnWeb Git リポジトリをインポートする

次に、アプリケーション コードを含むサンプル リポジトリをインポートします。

1. Azure DevOps 組織で、**eShopOnWeb** プロジェクトを開きます
1. **[リポジトリ] > [ファイル]** を選択します
1. **インポート** を選択する
1. **[Git リポジトリのインポート]** ウィンドウに、次の URL を貼り付けます: `https://github.com/MicrosoftLearning/eShopOnWeb.git`
1. **インポート** を選択する

   ![リポジトリのインポート パネルのスクリーンショット](media/import-repo.png)

リポジトリは次のように構成されています。

- **.ado** フォルダーには、Azure DevOps の YAML パイプラインが含まれています
- **.devcontainer** フォルダーには、コンテナーを使用して開発するためのセットアップが含まれています
- **infra** フォルダーには、Bicep と ARM のコードとしてのインフラストラクチャのテンプレートが含まれています
- **.github** フォルダーには、YAML GitHub ワークフローの定義が含まれています
- **src** フォルダーには、ラボ シナリオで使用される .NET 8 Web サイトが含まれています

1. **[リポジトリ] > [ブランチ]** に移動します
1. **main** ブランチにカーソルを合わせ、右側の省略記号を選択します
1. **[既定のブランチとして設定]** を選択します

## CI パイプラインをセットアップして eShopOnWeb コンテナーをビルドする

eShopOnWeb コンテナー イメージをビルドして Azure Container Registry (ACR) にプッシュする CI パイプラインを作成します。

### サービス接続をセットアップする

Azure Resource Manager サービス接続を使用すると、パイプラインから Azure Key Vault などの Azure リソースに接続できます。 この接続により、パイプラインを使用して、毎回認証する必要なく、Azure App Service アプリなどの Azure リソースにデプロイできます。

1. Azure DevOps プロジェクトで、**[プロジェクト設定] > [サービス接続]** に移動します。
1. **[サービス接続の作成]**、**[Azure Resource Manager]**、**[次へ]** の順に選択します。
1. **[新しい Azure サービス接続]** ペインで、次の設定を確認し、**[保存]** を選択します
   - **ID の種類**: アプリの登録 (自動)
   - **Credential**:ワークロード ID フェデレーション
   - **[Scope level]\(スコープ レベル\)**:サブスクリプション
   - **[サブスクリプション]**: "このラボで使用しているサブスクリプションを選択します"__
   - **サービス接続名**: `azure subs`
   - **すべてのパイプラインにアクセス許可を付与**: 有効

### CI パイプラインをセットアップして実行する

Azure Container Registry を作成し、コンテナー イメージをビルドして発行する既存の CI YAML パイプライン定義をインポートします。

1. ラボ コンピューターから、Azure DevOps プロジェクト **[eShopOnWeb]** に移動します
1. **[パイプライン] > [パイプライン]** に移動し、**[パイプラインの作成]** (または **[新しいパイプライン]**) を選択します
1. **[コードの場所]** ウィンドウで、**[Azure Repos Git (YAML)]** を選択します
1. **eShopOnWeb** リポジトリを選びます
1. **[構成]** セクションで、**[既存の Azure Pipelines YAML ファイル]** を選択します
1. **main** ブランチを選択します
1. パス **/.ado/eshoponweb-ci-dockercompose.yml** を指定します
1. **[続行]** を選択します

   ![既存のパイプライン YAML のスクリーンショット](media/select-ci-container-compose.png)

1. YAML パイプライン定義で、**AZ400-EWebShop-NAME** の **NAME** を一意の値に置き換えて、リソース グループ名をカスタマイズします
1. **YOUR-SUBSCRIPTION-ID** を自分の Azure サブスクリプション ID に置き換えます
1. **[保存して実行]** を選択し、パイプラインが正常に実行されるまで待ちます

    > **重要**: "この実行で ACI への Docker Compose を続行するには、このパイプラインに、リソースにアクセスするためのアクセス許可が必要です" というメッセージが表示された場合は、[表示]、[許可] の順に選択し、さらにもう一度 [許可] を選択します。 この操作は、パイプラインでリソースを作成するために必要です。

ビルド定義は、次のタスクで構成されます。

- **AzureResourceManagerTemplateDeployment** は、**bicep** を使用して Azure Container Registry をデプロイします
- **PowerShell** タスクは bicep 出力 (ACR ログイン サーバー) を受け取り、パイプライン変数を作成します
- **DockerCompose** タスクは、eShopOnWeb のコンテナー イメージをビルドし、Azure Container Registry にプッシュします

1. パイプラインには、プロジェクト名に基づく名前が付けられます。 識別しやすくするために、**[名前の変更]** を行いましょう
1. **[パイプライン] > [パイプライン]** に移動し、先ほど作成したパイプラインを選択します
1. 省略記号と **[名前の変更または削除]** オプションを選択します
1. **eshoponweb-ci-dockercompose** という名前を付け、**[保存]** をクリックします

1. 実行が完了したら、Azure portal で、先ほど定義したリソース グループを開きます
1. 作成したコンテナー イメージ (**eshoppublicapi** と **eshopwebmvc**) を含む Azure Container Registry (ACR) が見つかります

![ACR 内のコンテナー イメージのスクリーンショット](media/azure-container-registry.png)

1. **[アクセス キー]** を選択し、まだ有効にしていない場合は **[管理ユーザー]** を有効にし、**[パスワード]** の値をコピーします

![ACR パスワードの場所のスクリーンショット](media/acr-password.png)

このパスワードは、次のタスクで Azure Key Vault のシークレットとして使用します。

## Azure Key Vault を作成する

ACR のパスワードをシークレットとして保存する Azure Key Vault を作成します。

1. Azure portal の **[リソース、サービス、ドキュメントの検索]** テキスト ボックスに「**Key Vault**」と入力し、**Enter** キーを押します
1. **[Key Vault]** ブレードを選択し、**[作成] > [Key Vault]** を選択します
1. **[キー コンテナーの作成]** ブレードの **[基本情報]** タブで、次の設定を指定し、**[次へ]** を選択します

   | 設定                       | 値                                                           |
   | ----------------------------- | --------------------------------------------------------------- |
   | サブスクリプション                  | このラボで使用している Azure サブスクリプションの名前    |
   | リソース グループ                | お使いのリソース グループの名前 (**AZ400-EWebShop-NAME**)         |
   | キー コンテナー名                | **ewebshop-kv-NAME** などの一意の有効な名前 (NAME を置き換えてください) |
   | リージョン                        | ラボ環境の場所に近い Azure リージョン   |
   | Pricing tier                  | **Standard**                                                    |
   | 削除されたボールトを保持する日数 | **7**                                                           |
   | 消去保護              | **消去保護を無効にする**                                    |

1. **[アクセス構成]** タブで、**[Vault アクセス ポリシー]** が選択されていることを確認します
1. **[アクセス ポリシー]** セクションで、**[+ 作成]** を選択して新しいポリシーをセットアップします

   > **注**:許可されたアプリケーションとユーザーのみを許可することにより、Key Vault のアクセスを保護する必要があります。 Vault からデータにアクセスするには、パイプラインでの認証のためにサービス接続に対する読み取り (取得および一覧表示) アクセス許可を提供する必要があります。

1. **[アクセス許可]** ブレードで、**[シークレットのアクセス許可]** の下にある **[取得]** と **[一覧表示]** のアクセス許可をオンにします
1. **[次へ]** を選択します
1. **[プリンシパル]** ブレードで、**[Azure サブスクリプション サービス接続]** を検索します

   > **注**:サービス接続のプリンシパルがどのように識別されるかを確認するには、Azure DevOps で、**[プロジェクトの設定] > [サービス接続] > [azure subs]** に移動し、**アプリ登録の管理** リンクを開くことができます。 これにより、前の手順で検索するために使用できるプリンシパルの名前とアプリケーション ID を含む新しい Azure portal タブが開きます。

1. 一覧からそれを選択し、**[次へ]**、**[次へ]**、**作成** (アクセス ポリシー) の順に選択します
1. **[キー コンテナーの作成]** ブレードに戻り、**[確認と作成] > [作成]** を選択します

    > **注**: Azure Key Vault がプロビジョニングされるのを待ちます。 これにかかる時間は 1 分未満です。

1. **[デプロイが完了しました]** ブレードで、**[リソースに移動]** を選択します
1. [Azure Key Vault] ブレードの左側にある垂直メニューの **[オブジェクト]** セクションで、**[シークレット]** を選択します
1. **[シークレット]** ブレードで、**[生成/インポート]** を選択します
1. **[シークレットの作成**] ブレードで、次の設定を指定し、**[作成]** を選択します

| 設定        | 値                                       |
| -------------- | ------------------------------------------- |
| Upload options | **手動**                                  |
| 名前           | **acr-secret**                              |
| シークレット値   | 前のタスクでコピーした ACR アクセス パスワード |

## Azure Key Vault に接続された変数グループを作成する

Azure DevOps に、Key Vault から ACR パスワード シークレットを取得する変数グループを作成します。

1. ラボ コンピューターで、Azure DevOps オブジェクト **[eShopOnWeb]** に移動します
1. 垂直のナビゲーション ウィンドウで、**[リポジトリ] > [ファイル]** を選択します
1. **[+ 変数グループ]** を選択します
1. **[新しい変数グループ]** ブレードで、次の設定を指定します

   | 設定                              | 値                                               |
   | ------------------------------------ | --------------------------------------------------- |
   | 変数グループ名                  | **eshopweb-vg**                                     |
   | Azure Key Vault のシークレットにリンクする | **enable**                                          |
   | Azure サブスクリプション                   | **[利用可能な Azure サービス接続] > [Azure subs]** |
   | キー コンテナー名                       | キー コンテナー名                                 |

1. **[変数]** の下の **[+ 追加]** を選択し、**[acr-secret]** シークレットを選択します
1. **[OK]** を選択します。
1. **[保存]** を選びます。

   ![変数グループの作成のスクリーンショット](media/vg-create.png)

## Azure Container Instances (ACI) にコンテナーをデプロイする CD パイプラインをセットアップする

CD パイプラインをインポートしてカスタマイズし、それを実行して、コンテナー イメージを Azure Container Instances にデプロイします。

1. ラボ コンピューターから、Azure DevOps プロジェクト **[eShopOnWeb]** に移動します
1. **[パイプライン] >[パイプライン]** に移動し、**[新しいパイプライン]** を選択します
1. **[コードの場所]** ウィンドウで、**[Azure Repos Git (YAML)]** を選択します
1. **eShopOnWeb** リポジトリを選びます
1. **[構成]** セクションで、**[既存の Azure Pipelines YAML ファイル]** を選択します
1. **main** ブランチを選択します
1. パス **/.ado/eshoponweb-cd-aci.yml** を指定します
1. **[続行]** を選択します

1. YAML パイプライン定義で、次をカスタマイズします。

   - **YOUR-SUBSCRIPTION-ID** を、お使いの Azure サブスクリプション ID に置き換えます
   - **az400eshop-NAME** の NAME を置き換えて、グローバルに一意にします
   - **YOUR-ACR.azurecr.io** と **ACR-USERNAME** を ACR ログイン サーバーに置き換えます (どちらも ACR 名を必要とし、[ACR] > [アクセス キー] で確認できます)
   - **AZ400-EWebShop-NAME** をラボで前に定義したリソース グループ名に置き換えます

1. **[保存して実行]** を選択します
1. パイプラインを開き、正常に実行されるまで待ちます

    > **重要**: "この実行で ACI への Docker Compose を続行するには、このパイプラインに、リソースにアクセスするためのアクセス許可が必要です" というメッセージが表示された場合は、[表示]、[許可] の順に選択し、さらにもう一度 [許可] を選択します。 この操作は、パイプラインでリソースを作成するために必要です。

CD の定義は次のタスクで構成されます。

- **リソース**: CI パイプラインの完了に基づいて自動的にトリガーされるように準備されています。 また、bicep ファイルのリポジトリもダウンロードします
- **変数 (デプロイ ステージ用)** は変数グループに接続して、Azure Key Vault シークレット **acr-secret** を使用します
- **AzureResourceManagerTemplateDeployment** は、bicep テンプレートを使用して Azure Container Instances (ACI) をデプロイし、ACR ログイン パラメーターを指定して、ACI が以前に作成したコンテナー イメージを Azure Container Registry (ACR) からダウンロードできるようにします

1. パイプライン デプロイの結果を確認するには、Azure portal で、**[AZ400-EWebShop-NAME]** リソース グループを検索して選択します
1. リソースの一覧で、**[az400eshop]** コンテナー インスタンスがパイプラインによって作成されたことを確認します
1. 識別しやすくするために、パイプラインの名前を **shoponweb-cd-aci** に変更します

## リソースをクリーンアップする

不要な料金が発生しないように、Azure portal で作成されたリソースを必ず削除してください。

1. Azure portal で、**AZ400-EWebShop-NAME** リソース グループに移動します
1. **[リソース グループの削除]** を選択します。
1. リソース グループの名前を入力して、削除を確認します
1. **[削除]** を選択します

## まとめ

このラボでは、次の手順を使用して、Azure Key Vault を Azure DevOps パイプラインと統合しました。

- ACR のパスワードをシークレットとして保存する Azure Key Vault を作成する
- Azure Key Vault 内のシークレットへのアクセスを提供する
- シークレットを読み取るアクセス許可を構成する
- Azure Key Vault からパスワードを取得し、それを以降のタスクに渡すようにパイプラインを構成する
- シークレットを使用して、コンテナー イメージを Azure Container Instances (ACI) にデプロイする
- Azure Key Vault に接続された変数グループを作成する

Azure Key Vault と Azure DevOps の統合により、ソース コードと構成ファイルからシークレットを隠して、セキュリティのベスト プラクティスに従って、CI/CD パイプライン内の機密データを安全に処理できます。

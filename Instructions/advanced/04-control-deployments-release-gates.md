---
lab:
  topic: Advanced
  title: リリース ゲートを使用したデプロイの制御
  description: デプロイ ゲートを構成し、それらを使用して環境固有のデプロイ条件で Azure Pipelines の実行を制御する方法を学習します。
---

# リリース ゲートを使用したデプロイの制御

**推定所要時間:** 75 分

デプロイ ゲートを構成し、それらを使用して Azure Pipelines の実行を制御する方法を学習します。 Azure Web アプリの 2 つの環境を使用してリリース定義を構成し、ブロッキング バグがない場合にのみ DevTest 環境にデプロイし、Application Insights にアクティブなアラートがない場合にのみ DevTest 環境を完了としてマークします。

## 開始する前に

必要なもの:

- **Microsoft Edge** または [Azure DevOps 対応ブラウザー](https://docs.microsoft.com/azure/devops/server/compatibility)
- **Azure サブスクリプション:** アクティブな Azure サブスクリプションが必要です。または新しいサブスクリプションを作成することもできます
- **Azure DevOps 組織:** お持ちでない場合は、[組織またはプロジェクト コレクションの作成](https://docs.microsoft.com/azure/devops/organizations/accounts/create-organization)に関する記事を参考にして作成してください
- **アカウントのアクセス許可:** 次のロールを持つ Microsoft アカウントまたは Microsoft Entra アカウントが必要です
  - Azure サブスクリプション内の所有者ロール
  - Microsoft Entra テナント内のグローバル管理者ロール
  - 詳細については、「[Azure portal を使用して Azure ロールの割り当てを一覧表示する](https://docs.microsoft.com/azure/role-based-access-control/role-assignments-list-portal)」および [Azure Active Directory での管理者ロールの表示と割り当て](https://docs.microsoft.com/azure/active-directory/roles/manage-roles-portal)に関する記事を参照してください

## リリース ゲートについて

リリース パイプラインは、さまざまな環境にデプロイされるアプリケーションのエンドツーエンドのリリース プロセスを指定します。 各環境へのデプロイは、ジョブとタスクを使用して完全に自動化されます。 更新プログラムを段階的に公開することがベスト プラクティスです。つまり、一部のユーザーに公開し、その使用状況を監視てからし、最初のユーザー セットの経験に基づいて他のユーザーにも公開します。

承認とゲートを使用すると、リリースのデプロイの開始と完了を制御できます。 承認を使用すると、ユーザーがデプロイを手動で承認または拒否するのを待つことができます。 リリース ゲートを使用すると、リリースを次の環境にレベル上げする前に満たす必要のあるアプリケーション正常性基準を指定できます。

ゲートは、デプロイ前の条件またはデプロイ後の条件パネルから、リリース定義の環境に追加できます。 複数のゲートを追加して、リリースのすべての入力が正常に行われるようにすることができます。

既定で次の 4 種類のゲートが含まれます

- **Azure 関数の呼び出し:** Azure 関数の実行をトリガーし、正常に完了するようにします
- **Azure Monitor アラートのクエリ:** アクティブなアラートの構成済みの Azure Monitor 警告ルールを確認します
- **REST API の呼び出し:** REST API を呼び出して、成功の応答が返されたら続行します
- **作業項目のクエリ:** クエリから返された一致する作業項目の数がしきい値内であることを確認します

## チーム プロジェクトを作成して構成する

まず、このラボ用の Azure DevOps プロジェクトを作成します。

1. ブラウザーで、Azure DevOps 組織を開きます
1. **[新しいプロジェクト]** を選択します
1. プロジェクトに **eShopOnWeb** という名前を付けます
1. 他のフィールドは既定値のままにしておきます
1. **[作成]** を選択します

   ![[新しいプロジェクトの作成] パネルのスクリーンショット](media/create-project.png)

## eShopOnWeb Git リポジトリをインポートする

次に、アプリケーション コードを含むサンプル リポジトリをインポートします。

1. Azure DevOps 組織で、**eShopOnWeb** プロジェクトを開きます
1. **[リポジトリ] > [ファイル]** を選択します
1. **[リポジトリのインポート]** を選択します
1. **インポート** を選択する
1. **[Git リポジトリのインポート]** ウィンドウに、次の URL を貼り付けます: `https://github.com/MicrosoftLearning/eShopOnWeb.git`
1. **インポート** を選択する

   ![リポジトリのインポート パネルのスクリーンショット](media/import-repo.png)

リポジトリは次のように構成されています。

- **.ado** フォルダーには、Azure DevOps の YAML パイプラインが含まれています
- **.devcontainer** フォルダーには、コンテナーを使用して開発するためのセットアップが含まれています
- **infra** フォルダーには、Bicep と ARM のコードとしてのインフラストラクチャのテンプレートが含まれています
- **.github** フォルダーには、YAML GitHub ワークフローの定義が含まれています
- **src** フォルダーには、ラボ シナリオで使用される .NET 8 Web サイトが含まれています

1. **[リポジトリ] > [ブランチ]** に移動します
1. **main** ブランチにカーソルを合わせ、右側の省略記号を選択します
1. **[既定のブランチとして設定]** を選択します

## CI/CD パイプラインを構成する

YAML ビルド定義をプロジェクトに追加します。

1. **[パイプライン]** セクションに移動します
1. **[最初のパイプラインの作成]** ウィンドウで、**[パイプラインの作成]** を選択します
1. **[コードの場所]** ペインで、**[Azure Repos Git (YAML)]** を選択します
1. **[リポジトリの選択]** ペインで、**[eShopOnWeb]** を選択します
1. **[パイプラインを構成する]** ペインで、下方向にスクロールして **[既存の Azure Pipelines YAML ファイル]** を選択します
1. **[既存の YAML ファイルを選択する]** ペインで、次のように指定します
   - [ブランチ]: **main**
   - パス: **.ado/eshoponweb-ci.yml**
1. **[続行]** を選択して、これらの設定を保存します
1. **[パイプライン YAML をレビューする]** 画面で **[実行]** を選択して、ビルド パイプラインを開始します
1. ビルド パイプラインが正常に完了するまで待ちます
1. **[パイプライン] > [パイプライン]** に移動し、先ほど作成したパイプラインを選択します
1. 省略記号を選択して、**[名前の変更または移動]** オプションを選択します
1. パイプラインに **eshoponweb-ci** という名前を付けて、**[保存]** を選択します

## リリース パイプライン用の Azure リソースを作成する

DevTest 環境と運用環境を表す 2 つの Azure Web アプリを作成します。

### 2 つの Azure Web アプリを作成する

1. ラボ コンピューターから、[Azure portal](https://portal.azure.com) に移動します
1. Azure サブスクリプションに所有者ロールがあるユーザー アカウントでサインインします
1. Azure portal で、**[Cloud Shell]** アイコン (検索ボックスの右側にあります) を選択します
1. **Bash** または **PowerShell** のいずれかを選択するように求められたら、**[Bash]** を選択します

> **注**:Cloud Shell を初めて起動すると、"ストレージがマウントされていません" というメッセージが表示されます。その場合は、サブスクリプションを選択し、[適用] を選択します。

1. Bash プロンプトから、次のコマンドを実行してリソース グループを作成します (`<region>` を任意の Azure リージョンに置き換えます)

   ```bash
   REGION='<region>'
   RESOURCEGROUPNAME='az400m03l08-RG'
   az group create -n $RESOURCEGROUPNAME -l $REGION
   ```

1. App Service プランを作成します

   ```bash
   SERVICEPLANNAME='az400m03l08-sp1'
   az appservice plan create -g $RESOURCEGROUPNAME -n $SERVICEPLANNAME --sku S1
   ```

1. 一意の名前を持つ 2 つの Web アプリを作成します

   ```bash
   SUFFIX=$RANDOM$RANDOM
   az webapp create -g $RESOURCEGROUPNAME -p $SERVICEPLANNAME -n RGATES$SUFFIX-DevTest
   az webapp create -g $RESOURCEGROUPNAME -p $SERVICEPLANNAME -n RGATES$SUFFIX-Prod
   ```

> **注**: DevTest Web アプリの名前を記録します。 この情報は後で必要になります。

> **注**:サブスクリプションが名前空間 'Microsoft.Web' を使用するように登録されていないというエラーが発生した場合は、`az provider register --namespace Microsoft.Web` を実行し、登録が完了するまで待ちます。

1. プロビジョニング プロセスが完了するまで待ってから、Cloud Shell ペインを閉じます

### Application Insights リソースを構成する

1. Azure portal で **Application Insights** を検索し、結果からそれを選択します
1. **[Application Insights]** ブレードで、**[+ 作成]** を選択します
1. **[基本情報]** タブで、次の設定を指定します

   | 設定        | 値                                                  |
   | -------------- | ------------------------------------------------------ |
   | リソース グループ | **az400m03l08-RG**                                     |
   | Name           | 前のタスクの DevTest Web アプリの名前 |
   | リージョン         | Web アプリをデプロイしたものと同じ Azure リージョン  |

1. **[確認と作成]**、**[作成]** の順に選択します
1. プロビジョニング プロセスが完了するまで待機します。
1. リソース グループ **[az400m03l08-RG]** に移動します
1. リソースの一覧で、**[DevTest]** Web アプリを選択します
1. DevTest Web アプリ ページの左側のメニューで、**[監視]** の下にある **[Application Insights]** を選択します
1. **[Application Insights を有効にする]** を選択します
1. **[リソースの変更]** セクションで、**[既存のリソースの選択]** を選択します
1. 新しく作成した Application Insights リソースを選択します
1. **[適用]** を選択し、確認を求められたら、**[はい]** を選択します
1. 変更が有効になるまで待ちます

### 監視アラートを作成する

1. 同じ **[Application Insights]** メニューから、**[Application Insights データの表示]** を選択します
1. Application Insights リソースのブレードで、**[監視]** の下にある **[アラート]** を選択します
1. **[作成] > [アラート ルール]** を選択します
1. **[条件]** セクションで、**[すべてのシグナルを表示]** を選択します
1. 「**要求**」と入力し、結果から **[失敗した要求]** を選択します
1. **Condition** セクションで、**[しきい値]** を **[静的]** に設定したまま、次の既定値を検証します
   - 集計の種類: Count
   - 演算子:より大きい
   - 単位:Count
1. **[しきい値]** テキスト ボックスに「**0**」と入力します
1. **[次へ: アクション >]** を選択します
1. [アクション] では変更を行わずに、**[詳細]** で次のパラメーターを定義します

   | 設定                                        | 値                            |
   | ---------------------------------------------- | -------------------------------- |
   | 重大度                                       | **2- 警告**                   |
   | アラート ルール名                                | **RGATESDevTest_FailedRequests** |
   | 詳細オプション: アラートを自動的に解決する | **オフ**                      |

1. **[確認と作成]**、**[作成]** の順に選択します
1. アラート ルールが正常に作成されるまで待ちます

> **注**:メトリック アラートをルールがアクティブになるまでに最大 10 分かかる場合があります。

## リリース パイプラインを構成する

デプロイ ゲートを使用するリリース パイプラインを構成します。

### リリース タスクを設定する

1. Azure DevOps 内の **eShopOnWeb** プロジェクトから、**[パイプライン]**、**[リリース]** の順に選択します
1. **[新しいパイプライン]** を選択します
1. **[テンプレートの選択]** ウィンドウで、**[おすすめ]** テンプレートの下にある **[Azure App Service のデプロイ]** を選択します
1. **[適用]** を選択します
1. [ステージ] ウィンドウで、既定の "Stage 1" という名前を **DevTest** に更新します
1. **[X]** ボタンを使用してポップアップ ウィンドウを閉じます
1. ページの上部で、パイプラインの名前を "**New release pipeline**" から **eshoponweb-cd** に変更します
1. DevTest ステージにカーソルを合わせ、**[複製]** ボタンを選択します
1. 複製されたステージに **Production** という名前を付けます

> **注**: 現在、パイプラインには、**DevTest** と**運用**という名前の 2 つのステージが含まれています。

1. **[パイプライン]** タブで、**[成果物の追加]** の四角形を選択します
1. **[ソース (ビルド パイプライン)]** フィールドで **[eshoponweb-ci]** を選択します
1. **[追加]** を選択して、選択を確認します
1. **[成果物]** の四角形から、**[継続的デプロイのトリガー]** (稲妻) を選択します
1. **[無効]** を選択してスイッチを切り替え、有効にします
1. 他の設定はすべて既定値のままにして、ペインを閉じます

### DevTest ステージを構成する

1. **[DevTest 環境]** ステージ内で、ラベル **[1 ジョブ、1 タスク]** を選択します
1. **[Azure サブスクリプション]** ドロップダウン リストで、お使いの Azure サブスクリプションを選択し、**[承認]** を選択します
1. Azure サブスクリプションに所有者ロールがあるユーザー アカウントを使用して認証します
1. [アプリの種類] が [Web App on Windows] に設定されていることを確認します
1. **[App Service 名]** ドロップダウン リストで、**[DevTest]** Web アプリの名前を選択します
1. タスク **[Azure App Service のデプロイ]** を選択します
1. **[パッケージまたはフォルダー]** フィールドで、既定値を `$(System.DefaultWorkingDirectory)/**/Web.zip` に更新します
1. **[アプリケーションと構成の設定]** を開き、**[アプリの設定]** に「`-UseOnlyInMemoryDatabase true -ASPNETCORE_ENVIRONMENT Development`」と入力します

### 運用ステージを構成する

1. **[パイプライン]** タブに移動し、**[運用]** ステージ内で **[1 ジョブ、1 タスク]** を選択します
1. [タスク] タブの **[Azure サブスクリプション]** ドロップダウンで、DevTest ステージに使用した Azure サブスクリプションを選択します
1. **[App Service 名]** ドロップダウン リストで、**Prod** Web アプリの名前を選択します
1. タスク **[Azure App Service のデプロイ]** を選択します
1. **[パッケージまたはフォルダー]** フィールドで、既定値を `$(System.DefaultWorkingDirectory)/**/Web.zip` に更新します
1. **[アプリケーションと構成の設定]** を開き、**[アプリの設定]** に「`-UseOnlyInMemoryDatabase true -ASPNETCORE_ENVIRONMENT Development`」と入力します
1. **[保存]** を選択し、[保存] ダイアログ ボックスで **[OK]** を選択します

### リリース パイプラインをテストする

1. **[パイプライン]** セクションで、**[パイプライン]** を選択します
1. **[eshoponweb-ci]** ビルド パイプラインを選択し、**[パイプラインの実行]** を選択します
1. 既定の設定を受け入れ、**[実行]** を選択してパイプラインをトリガーします
1. ビルド パイプラインが完了するまで待ちます

> **注**:ビルドが成功すると、リリースが自動的にトリガーされ、アプリケーションが両方の環境にデプロイされます。

1. **[パイプライン]** セクションで、**[リリース]** を選択します
1. **[eshoponweb-cd]** ペインで、最新のリリースを表すエントリを選択します
1. リリースの進行状況を追跡し、両方の Web アプリへのデプロイが正常に完了したことを確認します
1. Azure portal に切り替えて、**[az400m03l08-RG]** リソース グループに移動します
1. **[DevTest]** Web アプリを選択し、**[参照]** を選択します
1. 新しいブラウザー タブで Web ページが正常に読み込まれたことを確認します
1. **[Production]** Web アプリに対して繰り返します
1. EShopOnWeb Web サイトを表示しているブラウザー タブを閉じます

## リリース ゲートを構成する

リリース パイプラインに品質ゲートを設定します。

### 承認用のデプロイ前ゲートを構成する

1. Azure DevOps ポータルで、**eShopOnWeb** プロジェクトを開きます
1. **[パイプライン] > [リリース]** で、**[eshoponweb-cd]**、**[編集]** の順に選択します
1. **[DevTest 環境]** ステージの左端で、**[デプロイ前の条件]** を表す楕円形を選択します
1. **[デプロイ前の条件]** ペインで、**[デプロイ前の承認]** スライダーを **[有効]** に設定します
1. **[承認]** テキスト ボックスに Azure DevOps アカウント名を入力して選択します

> **注**: 実際のシナリオでは、これは自分の名前ではなく DevOps チーム名の別名にする必要があります。

1. 承認前の設定を **[保存]** し、ポップアップ ウィンドウを閉じます
1. **[リリースの作成]** を選択し、**[作成]** を押して確認します
1. "Release-2" が作成されたことに注意してください。 "Release-2" リンクを選択して、その詳細に移動します
1. **[DevTest]** ステージが **[承認待ち]** 状態であることに注意してください
1. **[承認]** ボタンを選択して DevTest ステージをトリガーします

### Azure Monitor 用のデプロイ後ゲートを構成する

1. **[eshoponweb-cd]** ペインに戻り、**[DevTest 環境]** ステージの右端で、**[デプロイ後の条件]** を表す楕円形を選択します
1. **[ゲート]** スライダーを **[有効]** に設定します
1. **[+ 追加]** を選択し、**[Azure Monitor アラートのクエリ]** を選択します
1. **[Azure Monitor アラートのクエリ]** セクションで、次の設定を行います
   - **Azure サブスクリプション**: お使いの Azure サブスクリプションを表すサービス接続を選択します
   - **[リソース グループ]**: **[az400m03l08-RG]** を選択します
1. **[詳細]** セクションを展開して構成します
   - フィルターの種類: **なし**
   - 重大度: **Sev0、Sev1、Sev2、Sev3、Sev4**
   - 時間の範囲: **過去 1 時間**
   - アラートの状態: **確認済み、新規**
   - 監視条件: **起動済み**
1. **[評価オプション]** を展開して構成します
   - **ゲートの再評価までの時間**: **5 分**
   - **ゲートが失敗するまでのタイムアウト**: **8 分**
   - **[正常に実行されたゲートで、承認を求める]** を選択します

> **注**:サンプリング間隔とタイムアウトは連携して機能するため、ゲートは適切な間隔で関数を呼び出し、デプロイがタイムアウト期間内に成功しない場合はそのデプロイを拒否します。

1. **[デプロイ後の条件]** ペインを閉じます
1. **[保存]** を選択し、[保存] ダイアログ ボックスで **[OK]** を選択します

## リリース ゲートをテストする

アプリケーションを更新し、デプロイをトリガーして、リリース ゲートをテストします。

### アラートを生成してリリース プロセスをテストする

1. Azure portal から、**[DevTest Web アプリ]** リソースを参照します
1. [概要] ペインで、**[URL]** フィールドに Web アプリケーションのハイパーリンクが表示されていることに注意してください
1. このリンクを選択して、eShopOnWeb Web アプリケーションを開きます
1. **[失敗した要求]** をシミュレートするには、URL に **/discount** を追加します。その結果、そのページは存在しないため、エラー メッセージが発生します
1. このページを数回更新して、複数のイベントを生成します
1. Azure portal で **[Application Insights]** を検索し、**[DevTest-AppInsights]** リソースを選択します
1. **[アラート]** に移動します
1. **[重大度 2 - 警告]** の新しいアラートが少なくとも **1** 件表示されます

> **注:** アラートがまだ表示されない場合は、さらに数分待ってください。

1. Azure DevOps ポータルに戻り、**[eShopOnWeb]** プロジェクトを開きます
1. **[パイプライン] > [リリース]** に移動し、**[eshoponweb-cd]** を選択します
1. **[リリースの作成]** ボタンを選択します
1. リリース パイプラインが開始されるまで待って、DevTest ステージのリリース アクションを **[承認]** します
1. DevTest リリース ステージが正常に完了するまで待ちます
1. **[デプロイ後ゲート]** がどのようにして **[評価ゲート]** の状態に切り替わるかに注意してください
1. **[評価ゲート]** アイコンを選択します
1. **[Azure Monitor アラートのクエリ]** で、最初の失敗した状態に注意してください
1. リリースパイプラインを次の 5 分間保留状態のままにします
1. 5 分経過した後、2 回目の評価が再び失敗していることがわかります

これは予期される動作です。DevTest Web アプリに対して Application Insights アラートがトリガーされるためです。

> **注**:例外によってトリガーされるアラートがあるため、**[Azure Monitor のクエリ]** ゲートは失敗します。 これにより、**運用**環境へのデプロイが防止されます。

1. さらに数分待ってから、リリース ゲートの状態をもう一度検証します
1. 最初のリリース ゲートの確認から数分以内に、最初の Application Insights アラートが "発生" アクションでトリガーされたため、リリース ゲートは成功します。これにより、運用リリース ステージにデプロイできるようになります

> **注**:ゲートが失敗した場合は、Azure Monitor でアラートを閉じます。

## リソースをクリーンアップする

不要な料金が発生しないように、Azure portal で作成されたリソースを必ず削除してください。

1. Azure portal で、**[az400m03l08-RG]** リソース グループに移動します
1. **[リソース グループの削除]** を選択します。
1. リソース グループの名前を入力して、削除を確認します
1. **[削除]** を選択します

## まとめ

このラボでは、リリース パイプラインを構成してから、リリース ゲートを構成してテストしました。 以下の方法を学習しました。

- 複数の環境でリリース パイプラインを構成する
- デプロイ前の承認を手動制御用に設定する
- Azure Monitor アラートを使用してデプロイ後ゲートを構成する
- アプリケーション アラートを生成してリリース ゲートをテストする
- アプリケーションの正常性基準に基づいてデプロイを制御する

リリース ゲートを使用すると、リリースを次の環境に昇格する前に満たす必要があるアプリケーションの正常性基準を指定できるため、デプロイ パイプラインで品質管理を自動化できます。
